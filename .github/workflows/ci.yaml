name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.5.14"
  CACHE_VERSION: "0.1.0"

jobs:
  # Lint job - ruff check and format validation
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run ruff check
        run: uv run ruff check src/omniintelligence/tools/ tests/unit/tools/

      - name: Run ruff format check
        run: uv run ruff format --check src/omniintelligence/tools/ tests/unit/tools/

  # Type checking job - mypy
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Run mypy
        run: uv run mypy src/omniintelligence/tools/

  # Unit tests with coverage
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Run unit tests with coverage
        run: |
          uv run pytest tests/unit/tools/ \
            -v \
            --tb=short \
            --cov=src/omniintelligence/tools \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=junit-unit.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-unit
          path: |
            junit-unit.xml
            coverage.xml
          retention-days: 7

  # Contract validation - validates ONEX contract YAML files
  contract-validation:
    name: Contract Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Find and validate contracts
        run: |
          # Find all main contract files (*_contract.yaml) and FSM files (fsm_*.yaml)
          # Excludes subcontracts/ and workflows/ directories
          CONTRACT_FILES=$(find src/omniintelligence/nodes -type f \( -name "*_contract.yaml" -o -name "fsm_*.yaml" \) \
            ! -path "*/subcontracts/*" \
            ! -path "*/workflows/*" \
            | sort)

          if [ -z "$CONTRACT_FILES" ]; then
            echo "No contract files found to validate"
            exit 0
          fi

          echo "Validating contracts:"
          echo "$CONTRACT_FILES"
          echo ""

          # Run contract linter on all found files
          echo "Starting contract validation..."
          time uv run python -m omniintelligence.tools.contract_linter --verbose $CONTRACT_FILES
          echo "Contract validation complete"

  # Summary job - aggregates all job results
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, test-unit, contract-validation]
    if: always()

    steps:
      - name: Check results
        run: |
          lint="${{ needs.lint.result }}"
          typecheck="${{ needs.type-check.result }}"
          unittest="${{ needs.test-unit.result }}"
          contracts="${{ needs.contract-validation.result }}"

          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | $lint |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | $typecheck |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $unittest |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Validation | $contracts |" >> $GITHUB_STEP_SUMMARY

          if [[ "$lint" == "success" ]] && \
             [[ "$typecheck" == "success" ]] && \
             [[ "$unittest" == "success" ]] && \
             [[ "$contracts" == "success" ]]; then
            echo ""
            echo "All CI checks passed successfully!"
            exit 0
          else
            echo ""
            echo "One or more CI checks failed"
            exit 1
          fi
