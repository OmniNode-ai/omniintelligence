name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.5.14"
  CACHE_VERSION: "0.1.0"

jobs:
  # Lint job - ruff check and format validation
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run ruff check
        run: uv run ruff check src/omniintelligence/tools/ tests/unit/tools/

      - name: Run ruff format check
        run: uv run ruff format --check src/omniintelligence/tools/ tests/unit/tools/

  # Type checking job - mypy
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Run mypy
        run: uv run mypy src/omniintelligence/tools/

  # Unit tests with coverage
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Run unit tests with coverage
        run: |
          uv run pytest tests/unit/tools/ \
            -v \
            --tb=short \
            --cov=src/omniintelligence/tools \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=junit-unit.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-unit
          path: |
            junit-unit.xml
            coverage.xml
          retention-days: 7

  # Contract validation - validates ONEX contract YAML files
  contract-validation:
    name: Contract Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: >-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            ${{ hashFiles('**/uv.lock') }}-
            ${{ env.CACHE_VERSION }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}-
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: uv sync --group dev --group core

      - name: Find and validate contracts
        id: contract-validation
        run: |
          # Record start time
          START_TIME=$(date +%s)

          # Find all contract files in nodes directories
          # Searches both current and legacy node locations
          # Pattern matches: *_contract.yaml (compute, effect, reducer, orchestrator) and fsm_*.yaml
          # Excludes subcontracts/ and workflows/ directories which contain partial contract fragments
          CONTRACT_FILES=$(find src/omniintelligence -type d -name "nodes" -exec \
            find {} -type f \( -name "*_contract.yaml" -o -name "fsm_*.yaml" \) \
              ! -path "*/subcontracts/*" \
              ! -path "*/workflows/*" \; 2>/dev/null | sort)

          # Fail fast if no contracts found - prevents silent CI passes
          if [ -z "$CONTRACT_FILES" ]; then
            echo "::error::No contract files found! This indicates a path or pattern mismatch."
            echo "Searched in: src/omniintelligence/**/nodes/"
            echo "Expected patterns: *_contract.yaml, fsm_*.yaml"
            exit 1
          fi

          # Count contracts for metrics
          CONTRACT_COUNT=$(echo "$CONTRACT_FILES" | wc -l | tr -d ' ')
          echo "contract_count=$CONTRACT_COUNT" >> $GITHUB_OUTPUT

          echo "Found $CONTRACT_COUNT contract file(s) to validate:"
          echo "$CONTRACT_FILES"
          echo ""

          # Run contract linter on all found files
          echo "Starting contract validation..."
          VALIDATION_START=$(date +%s)

          if uv run python -m omniintelligence.tools.contract_linter --verbose $CONTRACT_FILES; then
            VALIDATION_STATUS="success"
          else
            VALIDATION_STATUS="failed"
          fi

          VALIDATION_END=$(date +%s)
          VALIDATION_DURATION=$((VALIDATION_END - VALIDATION_START))
          echo "validation_duration=${VALIDATION_DURATION}s" >> $GITHUB_OUTPUT

          END_TIME=$(date +%s)
          TOTAL_DURATION=$((END_TIME - START_TIME))
          echo "total_duration=${TOTAL_DURATION}s" >> $GITHUB_OUTPUT

          echo ""
          echo "Contract validation complete in ${VALIDATION_DURATION}s (total step: ${TOTAL_DURATION}s)"

          if [ "$VALIDATION_STATUS" = "failed" ]; then
            exit 1
          fi

  # Summary job - aggregates all job results
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, test-unit, contract-validation]
    if: always()

    steps:
      - name: Check results
        run: |
          lint="${{ needs.lint.result }}"
          typecheck="${{ needs.type-check.result }}"
          unittest="${{ needs.test-unit.result }}"
          contracts="${{ needs.contract-validation.result }}"

          # Status emoji mapping
          get_status_icon() {
            case "$1" in
              success) echo ":white_check_mark:" ;;
              failure) echo ":x:" ;;
              cancelled) echo ":no_entry_sign:" ;;
              skipped) echo ":fast_forward:" ;;
              *) echo ":question:" ;;
            esac
          }

          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Results table with status icons
          echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|:------:|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | $(get_status_icon $lint) | \`$lint\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | $(get_status_icon $typecheck) | \`$typecheck\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $(get_status_icon $unittest) | \`$unittest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Validation | $(get_status_icon $contracts) | \`$contracts\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "$lint" == "success" ]] && \
             [[ "$typecheck" == "success" ]] && \
             [[ "$unittest" == "success" ]] && \
             [[ "$contracts" == "success" ]]; then
            echo "### :rocket: All CI checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ready for review and merge." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### :warning: CI checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above and fix any issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
