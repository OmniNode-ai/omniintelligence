# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# I/O Audit Whitelist Configuration
#
# This file defines exceptions to the I/O audit rules for ONEX nodes.
# All exceptions must have a documented reason.
#
# ============================================================================
# IMPORTANT: Inline Pragma Requirement
# ============================================================================
# Inline pragmas (# io-audit: ignore-next-line <rule>) ONLY work for files
# that are listed in this YAML whitelist. This is BY DESIGN.
#
# If you add a pragma to a file NOT listed here, it will be SILENTLY IGNORED.
#
# Correct workflow:
#   1. Add the file to this YAML whitelist with allowed_rules
#   2. Then use inline pragmas in that file for line-level granularity
#
# This ensures all I/O exceptions are centrally tracked and code-reviewed.
# ============================================================================
#
# Rule IDs:
#   - net-client: Network/DB/external client imports
#   - env-access: Environment variable access
#   - file-io: File system operations
#
# Format:
#   files:
#     - path: "relative/path/to/file.py"  # or glob pattern
#       reason: "Why this exception is needed"
#       allowed_rules:
#         - "rule-id"
#
# Example with inline pragma usage:
#   1. Add entry here:
#      - path: "src/omniintelligence/nodes/my_effect_node.py"
#        reason: "Effect node requires Kafka"
#        allowed_rules:
#          - "net-client"
#
#   2. In my_effect_node.py, use pragma for specific lines:
#      # io-audit: ignore-next-line net-client
#      from confluent_kafka import Producer

schema_version: "1.0.0"

files:
  # Test fixtures are whitelisted for testing purposes
  # Note: Inline pragmas work in this file because it's listed here
  - path: "tests/audit/fixtures/io/whitelisted_node.py"
    reason: "Test fixture for whitelist functionality"
    allowed_rules:
      - "env-access"
      - "file-io"

  # This is the proper location for bootstrap configuration - values are then
  # passed to nodes via constructor injection, maintaining node purity.
  - path: "src/omniintelligence/nodes/*/__main__.py"
    # Entry point files (__main__.py) are allowed to read environment variables
    # and perform file I/O (reading input JSON files, writing output files).
    reason: "Entry point files bootstrap configuration from environment variables and handle CLI file
      I/O (reading input data, writing output results)"
    allowed_rules:
      - "env-access"
      - "file-io"

  # Effect node for crawling git repositories — must read file bytes to compute
  # content hashes. File I/O is the core purpose of this Effect node.
  - path: "src/omniintelligence/nodes/node_git_repo_crawler_effect/handlers/handler_git_repo_crawl.py"
    reason: "Effect node reads repository files to compute SHA-256 content hashes; file I/O is the intended
      responsibility of this Effect node"
    allowed_rules:
      - "file-io"

  # DocumentFetchEffect (OMN-2389) — reads file content from disk for filesystem
  # and git_repo crawl sources. File I/O is the core responsibility of this Effect node.
  - path: "src/omniintelligence/nodes/node_document_fetch_effect/handlers/handler_document_fetch.py"
    reason: "Effect node reads document content from disk (filesystem and git_repo sources); file I/O
      is the intended responsibility of this Effect node"
    allowed_rules:
      - "file-io"

  # Adaptive classifier handler (OMN-2735) — reads the versioned label store YAML
  # (labels/intent_classes_v1.yaml) once at module initialization time to bootstrap
  # the AdaptiveClassifier centroid embeddings. This is one-time bootstrap I/O, not
  # per-request I/O. A proper Effect node refactor is tracked in a follow-up ticket.
  - path: "src/omniintelligence/nodes/node_intent_classifier_compute/handlers/handler_adaptive_classification.py"
    reason: "Reads versioned label store YAML (labels/intent_classes_v1.yaml) once at module init to bootstrap
      AdaptiveClassifier centroid embeddings; I/O is initialization-time only, not per-call"
    allowed_rules:
      - "file-io"

# Example of a legacy node pending refactor
# - path: "src/omniintelligence/nodes/legacy_*.py"
#   reason: "Legacy nodes pending refactor - tracked in OMN-XXX"
#   allowed_rules:
#     - "env-access"
