# ============================================================================
# OmniIntelligence - ONEX Nodes
# ============================================================================
# Purpose: ONEX 4.0 node deployments (orchestrator, reducer, compute, effect)
#
# Dependencies:
#   - omninode-bridge infrastructure must be running (postgres, redpanda, valkey)
#   - docker-compose.yml (qdrant, memgraph) should be running
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.nodes.yml up -d
#
# External Services (from omninode-bridge):
#   - PostgreSQL: omninode-bridge-postgres:5432
#   - Redpanda: omninode-bridge-redpanda:9092
#   - Valkey: omninode-bridge-valkey:6379
# ============================================================================

name: omniintelligence

networks:
  omninode-bridge-network:
    external: true

services:

  # ============================================================================
  # Intelligence Reducer - Pure FSM State Management
  # ============================================================================

  intelligence-reducer:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.reducer
    container_name: omni-intelligence-reducer
    environment:
      # Database Configuration (uses omninode-bridge postgres)
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:${POSTGRES_PASSWORD}@omninode-bridge-postgres:5432/omniintelligence}

      # Reducer Configuration
      ENABLE_LEASE_MANAGEMENT: ${ENABLE_LEASE_MANAGEMENT:-true}
      LEASE_TIMEOUT_SECONDS: ${LEASE_TIMEOUT_SECONDS:-300}
      MAX_RETRY_ATTEMPTS: ${MAX_RETRY_ATTEMPTS:-3}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    networks:
      - omninode-bridge-network
    # Note: postgres is external - no depends_on, just ensure omninode-bridge is running
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Intelligence Orchestrator - Llama Index Workflows
  # ============================================================================

  intelligence-orchestrator:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.orchestrator
    container_name: omni-intelligence-orchestrator
    environment:
      # Orchestrator Configuration
      MAX_CONCURRENT_WORKFLOWS: ${MAX_CONCURRENT_WORKFLOWS:-10}
      WORKFLOW_TIMEOUT_SECONDS: ${WORKFLOW_TIMEOUT_SECONDS:-300}
      ENABLE_CACHING: ${ENABLE_CACHING:-true}
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-300}

      # Dependencies (uses omninode-bridge valkey)
      REDUCER_URL: http://intelligence-reducer:8000
      VALKEY_URL: redis://:${VALKEY_PASSWORD}@omninode-bridge-valkey:6379/0

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    networks:
      - omninode-bridge-network
    depends_on:
      - intelligence-reducer
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # ============================================================================
  # Vectorization Compute Node
  # ============================================================================

  vectorization-compute:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.compute
      args:
        NODE_NAME: vectorization_compute
    container_name: omni-vectorization-compute
    environment:
      DEFAULT_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      MAX_BATCH_SIZE: ${VECTORIZATION_BATCH_SIZE:-100}
      ENABLE_CACHING: ${ENABLE_CACHING:-true}
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-3600}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Quality Scoring Compute Node
  # ============================================================================

  quality-scoring-compute:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.compute
      args:
        NODE_NAME: quality_scoring_compute
    container_name: omni-quality-scoring-compute
    environment:
      ONEX_VALIDATION_ENABLED: ${ONEX_VALIDATION_ENABLED:-true}
      GENERATE_RECOMMENDATIONS: ${GENERATE_RECOMMENDATIONS:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Entity Extraction Compute Node
  # ============================================================================

  entity-extraction-compute:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.compute
      args:
        NODE_NAME: entity_extraction_compute
    container_name: omni-entity-extraction-compute
    environment:
      MAX_CONTENT_SIZE: ${MAX_CONTENT_SIZE:-1000000}
      SUPPORTED_LANGUAGES: ${SUPPORTED_LANGUAGES:-python}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Relationship Detection Compute Node
  # ============================================================================

  relationship-detection-compute:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.compute
      args:
        NODE_NAME: relationship_detection_compute
    container_name: omni-relationship-detection-compute
    environment:
      ENABLE_CALLS_DETECTION: ${ENABLE_CALLS_DETECTION:-true}
      ENABLE_IMPORTS_DETECTION: ${ENABLE_IMPORTS_DETECTION:-true}
      ENABLE_INHERITANCE_DETECTION: ${ENABLE_INHERITANCE_DETECTION:-true}
      ENABLE_CONTAINMENT_DETECTION: ${ENABLE_CONTAINMENT_DETECTION:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Kafka Event Effect Node
  # ============================================================================

  kafka-event-effect:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.effect
      args:
        NODE_NAME: kafka_event_effect
    container_name: omni-kafka-event-effect
    environment:
      # Uses omninode-bridge redpanda
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-omninode-bridge-redpanda:9092}
      TOPIC_PREFIX: ${KAFKA_TOPIC_PREFIX:-dev.omni-intelligence}
      ENABLE_IDEMPOTENCE: ${KAFKA_ENABLE_IDEMPOTENCE:-true}
      ACKS: ${KAFKA_ACKS:-all}
      MAX_RETRIES: ${KAFKA_MAX_RETRIES:-3}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    # Note: redpanda is external - ensure omninode-bridge is running
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Qdrant Vector Effect Node
  # ============================================================================

  qdrant-vector-effect:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.effect
      args:
        NODE_NAME: qdrant_vector_effect
    container_name: omni-qdrant-vector-effect
    environment:
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      DEFAULT_COLLECTION: ${QDRANT_DEFAULT_COLLECTION:-archon_vectors}
      VECTOR_DIMENSION: ${VECTOR_DIMENSION:-1536}
      DISTANCE_METRIC: ${DISTANCE_METRIC:-cosine}
      BATCH_SIZE: ${QDRANT_BATCH_SIZE:-100}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Memgraph Graph Effect Node
  # ============================================================================

  memgraph-graph-effect:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.effect
      args:
        NODE_NAME: memgraph_graph_effect
    container_name: omni-memgraph-graph-effect
    environment:
      MEMGRAPH_HOST: ${MEMGRAPH_HOST:-memgraph}
      MEMGRAPH_PORT: ${MEMGRAPH_PORT:-7687}
      ENABLE_INDEXING: ${MEMGRAPH_ENABLE_INDEXING:-true}
      BATCH_SIZE: ${MEMGRAPH_BATCH_SIZE:-100}
      QUERY_TIMEOUT_SECONDS: ${MEMGRAPH_QUERY_TIMEOUT:-30}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    depends_on:
      memgraph:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # PostgreSQL Pattern Effect Node
  # ============================================================================

  postgres-pattern-effect:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.effect
      args:
        NODE_NAME: postgres_pattern_effect
    container_name: omni-postgres-pattern-effect
    environment:
      # Uses omninode-bridge postgres
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:${POSTGRES_PASSWORD}@omninode-bridge-postgres:5432/omniintelligence}
      ENABLE_FULL_TEXT_SEARCH: ${ENABLE_FULL_TEXT_SEARCH:-true}
      ENABLE_LINEAGE_TRACKING: ${ENABLE_LINEAGE_TRACKING:-true}
      BATCH_SIZE: ${PATTERN_BATCH_SIZE:-50}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - omninode-bridge-network
    # Note: postgres is external - ensure omninode-bridge is running
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
