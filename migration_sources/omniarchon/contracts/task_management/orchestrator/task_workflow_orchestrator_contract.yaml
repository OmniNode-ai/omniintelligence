# ONEX Task Workflow Orchestrator Contract
# Workflow coordination for complete task lifecycle management and multi-component orchestration

name: "TaskWorkflowOrchestrator"
version: "1.0.0"
description: "Orchestrator node for coordinating complete task workflows, multi-component operations, and business process management"
node_type: "orchestrator"

# Contract metadata
metadata:
  author: "ONEX Task Management System"
  created_date: "2025-09-04"
  tags: ["task", "workflow", "orchestrator", "coordination", "business-process"]
  complexity: "high"

# Input schema definition
inputs:
  workflow_operation:
    type: "string"
    required: true
    enum: [
      "create_task_workflow",
      "update_task_workflow",
      "status_change_workflow",
      "assignment_workflow",
      "bulk_operations_workflow",
      "notification_workflow",
      "dependency_resolution_workflow",
      "cleanup_workflow"
    ]
    description: "Type of workflow to orchestrate"

  workflow_context:
    type: "object"
    required: true
    description: "Context information for workflow execution"
    properties:
      workflow_id:
        type: "string"
        format: "uuid"
        description: "Unique workflow instance identifier"
      user_id:
        type: "string"
        required: true
        description: "User initiating the workflow"
      project_id:
        type: "string"
        format: "uuid"
        required: true
        description: "Associated project ID"
      correlation_id:
        type: "string"
        format: "uuid"
        description: "Correlation ID for distributed tracing"
      user_role:
        type: "string"
        enum: ["admin", "manager", "developer", "viewer"]
        description: "User role for authorization"

  task_data:
    type: "object"
    required: false
    description: "Task data for workflow operations"
    properties:
      task_id:
        type: "string"
        format: "uuid"
        description: "Existing task ID (for updates)"
      title:
        type: "string"
        max_length: 200
        description: "Task title"
      description:
        type: "string"
        max_length: 10000
        description: "Task description"
      status:
        type: "string"
        enum: ["todo", "doing", "review", "done"]
        description: "Task status"
      assignee:
        type: "string"
        description: "Task assignee"
      task_order:
        type: "integer"
        minimum: 0
        maximum: 100
        description: "Task priority order"
      feature:
        type: "string"
        max_length: 50
        description: "Feature grouping"
      due_date:
        type: "string"
        format: "date-time"
        description: "Task due date"
      sources:
        type: "array"
        items:
          type: "object"
        description: "Source references"
      code_examples:
        type: "array"
        items:
          type: "object"
        description: "Code examples"
      dependencies:
        type: "array"
        items:
          type: "string"
          format: "uuid"
        description: "Task dependencies"

  bulk_data:
    type: "array"
    required: false
    description: "Bulk operation data"
    items:
      type: "object"
    max_items: 100

  workflow_options:
    type: "object"
    required: false
    description: "Workflow execution options"
    properties:
      async_execution:
        type: "boolean"
        default: false
        description: "Execute workflow asynchronously"
      timeout_seconds:
        type: "integer"
        minimum: 1
        maximum: 300
        default: 60
        description: "Workflow timeout"
      retry_failed_steps:
        type: "boolean"
        default: true
        description: "Retry failed workflow steps"
      rollback_on_failure:
        type: "boolean"
        default: true
        description: "Rollback changes on workflow failure"
      notification_preferences:
        type: "object"
        properties:
          notify_on_completion:
            type: "boolean"
            default: true
          notify_on_failure:
            type: "boolean"
            default: true
          notification_channels:
            type: "array"
            items:
              type: "string"
              enum: ["email", "websocket", "webhook"]
        description: "Notification preferences"
      validation_level:
        type: "string"
        enum: ["basic", "strict", "comprehensive"]
        default: "strict"
        description: "Validation thoroughness level"

# Output schema definition
outputs:
  workflow_result:
    type: "object"
    required: true
    description: "Overall workflow execution result"
    properties:
      success:
        type: "boolean"
        required: true
        description: "Overall workflow success"
      workflow_id:
        type: "string"
        format: "uuid"
        required: true
        description: "Workflow instance ID"
      workflow_operation:
        type: "string"
        required: true
        description: "Type of workflow executed"
      execution_time_ms:
        type: "integer"
        required: true
        description: "Total workflow execution time"
      steps_executed:
        type: "integer"
        required: true
        description: "Number of workflow steps executed"
      steps_failed:
        type: "integer"
        required: true
        description: "Number of workflow steps that failed"

  step_results:
    type: "array"
    required: true
    description: "Results from individual workflow steps"
    items:
      type: "object"
      properties:
        step_name:
          type: "string"
          required: true
          description: "Name of the workflow step"
        step_type:
          type: "string"
          enum: ["validation", "database", "notification", "state_transition", "integration"]
          required: true
          description: "Type of workflow step"
        success:
          type: "boolean"
          required: true
          description: "Step execution success"
        execution_time_ms:
          type: "integer"
          required: true
          description: "Step execution time"
        output_data:
          type: "object"
          description: "Step output data"
        error_details:
          type: "object"
          description: "Error details if step failed"

  task_result:
    type: "object"
    required: false
    description: "Task operation result data"
    properties:
      task:
        type: "object"
        description: "Single task result"
      tasks:
        type: "array"
        items:
          type: "object"
        description: "Multiple task results (for bulk operations)"
      affected_count:
        type: "integer"
        description: "Number of tasks affected"

  notification_results:
    type: "array"
    required: false
    description: "Notification dispatch results"
    items:
      type: "object"
      properties:
        notification_type:
          type: "string"
        recipient:
          type: "string"
        delivery_status:
          type: "string"
          enum: ["sent", "failed", "pending"]
        delivery_time_ms:
          type: "integer"

  workflow_metadata:
    type: "object"
    required: true
    description: "Workflow execution metadata"
    properties:
      started_at:
        type: "string"
        format: "date-time"
        description: "Workflow start time"
      completed_at:
        type: "string"
        format: "date-time"
        description: "Workflow completion time"
      user_id:
        type: "string"
        description: "User who initiated workflow"
      correlation_id:
        type: "string"
        description: "Correlation ID for tracing"
      rollback_executed:
        type: "boolean"
        description: "Whether rollback was executed"
      retry_count:
        type: "integer"
        description: "Number of retries performed"

# Workflow definitions
workflows:
  create_task_workflow:
    description: "Complete task creation workflow"
    steps:
      - step: "validate_task_data"
        component: "TaskValidationCompute"
        description: "Validate input task data"
        timeout_ms: 1000

      - step: "store_task_data"
        component: "TaskDatabaseEffect"
        description: "Store task in database"
        timeout_ms: 5000
        depends_on: ["validate_task_data"]

      - step: "initialize_task_state"
        component: "TaskStateReducer"
        description: "Initialize task state"
        timeout_ms: 1000
        depends_on: ["store_task_data"]

      - step: "send_creation_notifications"
        component: "TaskNotificationEffect"
        description: "Send task creation notifications"
        timeout_ms: 3000
        depends_on: ["store_task_data"]
        optional: true

  update_task_workflow:
    description: "Task update workflow with validation"
    steps:
      - step: "validate_update_data"
        component: "TaskValidationCompute"
        description: "Validate update data"

      - step: "check_update_permissions"
        component: "TaskValidationCompute"
        description: "Verify user can update task"

      - step: "update_task_data"
        component: "TaskDatabaseEffect"
        description: "Update task in database"
        depends_on: ["validate_update_data", "check_update_permissions"]

      - step: "record_task_history"
        component: "TaskAuditEffect"
        description: "Record change history"
        depends_on: ["update_task_data"]

      - step: "send_update_notifications"
        component: "TaskNotificationEffect"
        description: "Send update notifications"
        depends_on: ["update_task_data"]
        optional: true

  status_change_workflow:
    description: "Task status change workflow"
    steps:
      - step: "validate_status_transition"
        component: "TaskStateReducer"
        description: "Validate status transition"

      - step: "execute_state_transition"
        component: "TaskStateReducer"
        description: "Execute status change"
        depends_on: ["validate_status_transition"]

      - step: "update_task_record"
        component: "TaskDatabaseEffect"
        description: "Update task status in database"
        depends_on: ["execute_state_transition"]

      - step: "record_transition_history"
        component: "TaskAuditEffect"
        description: "Record status change history"
        depends_on: ["execute_state_transition"]

      - step: "send_status_notifications"
        component: "TaskNotificationEffect"
        description: "Send status change notifications"
        depends_on: ["update_task_record"]

  bulk_operations_workflow:
    description: "Bulk task operations workflow"
    steps:
      - step: "validate_bulk_data"
        component: "TaskValidationCompute"
        description: "Validate bulk operation data"

      - step: "check_bulk_permissions"
        component: "TaskValidationCompute"
        description: "Verify permissions for all operations"

      - step: "execute_bulk_operation"
        component: "TaskDatabaseEffect"
        description: "Execute bulk database operations"
        depends_on: ["validate_bulk_data", "check_bulk_permissions"]
        timeout_ms: 30000

      - step: "record_bulk_history"
        component: "TaskAuditEffect"
        description: "Record bulk operation history"
        depends_on: ["execute_bulk_operation"]

      - step: "send_bulk_notifications"
        component: "TaskNotificationEffect"
        description: "Send notifications for affected tasks"
        depends_on: ["execute_bulk_operation"]
        optional: true

# Orchestration patterns
orchestration_patterns:
  parallel_execution:
    enabled: true
    max_parallel_steps: 5
    failure_handling: "fail_fast"

  sequential_execution:
    enabled: true
    step_dependency_resolution: "automatic"

  conditional_execution:
    enabled: true
    condition_evaluation: "runtime"

  retry_mechanisms:
    enabled: true
    max_retries: 3
    backoff_strategy: "exponential"
    retry_delay_ms: [1000, 2000, 4000]

# Component coordination
component_coordination:
  service_discovery:
    method: "registry_based"
    cache_timeout_ms: 30000

  inter_component_communication:
    protocol: "async_message_passing"
    timeout_ms: 10000

  error_propagation:
    strategy: "bubble_up_with_context"
    preserve_original_error: true

  transaction_coordination:
    pattern: "saga"
    compensation_actions: true

# Performance specifications
performance_constraints:
  max_workflow_execution_time_ms: 60000
  max_memory_usage_mb: 500
  max_concurrent_workflows: 100

  step_timeouts:
    validation: 1000
    database: 5000
    notification: 3000
    state_transition: 2000

# Error handling specification
error_handling:
  error_types:
    - name: "WORKFLOW_TIMEOUT_ERROR"
      description: "Workflow exceeded maximum execution time"
      recovery_action: "cancel_remaining_steps"
    - name: "STEP_EXECUTION_ERROR"
      description: "Individual workflow step failed"
      recovery_action: "retry_step_or_rollback"
    - name: "COMPONENT_UNAVAILABLE_ERROR"
      description: "Required component is unavailable"
      recovery_action: "wait_and_retry_or_fail"
    - name: "ROLLBACK_ERROR"
      description: "Rollback operation failed"
      recovery_action: "log_and_alert"
    - name: "COORDINATION_ERROR"
      description: "Component coordination failed"
      recovery_action: "reset_coordination_state"

  exception_chaining: true
  context_preservation: true

  rollback_strategies:
    - strategy: "compensating_actions"
      description: "Execute compensating actions for completed steps"
    - strategy: "state_restoration"
      description: "Restore previous state from snapshots"

# Dependencies
dependencies:
  - name: "TaskValidationCompute"
    type: "compute_node"
    description: "Task validation logic"
  - name: "TaskDatabaseEffect"
    type: "effect_node"
    description: "Database operations"
  - name: "TaskStateReducer"
    type: "reducer_node"
    description: "State management"
  - name: "TaskNotificationEffect"
    type: "effect_node"
    description: "Notification dispatch"
  - name: "TaskAuditEffect"
    type: "effect_node"
    description: "Audit logging"
  - name: "ComponentRegistry"
    type: "protocol"
    description: "Component discovery service"
  - name: "WorkflowEngine"
    type: "protocol"
    description: "Workflow execution engine"

# Monitoring and observability
monitoring:
  metrics:
    - name: "workflow_execution_time"
      type: "histogram"
      description: "Workflow execution time distribution"
    - name: "workflow_success_rate"
      type: "gauge"
      description: "Workflow success rate percentage"
    - name: "step_failure_count"
      type: "counter"
      description: "Individual step failure count"
    - name: "concurrent_workflows"
      type: "gauge"
      description: "Number of concurrent workflow executions"

  tracing:
    enabled: true
    trace_all_steps: true
    include_component_traces: true

# Testing specification
testing:
  unit_tests:
    - name: "test_workflow_execution"
      description: "Test complete workflow execution"
    - name: "test_error_handling"
      description: "Test error handling and rollback"
    - name: "test_component_coordination"
      description: "Test component coordination patterns"
    - name: "test_parallel_execution"
      description: "Test parallel step execution"
    - name: "test_workflow_timeouts"
      description: "Test workflow timeout handling"

  integration_tests:
    - name: "test_end_to_end_workflows"
      description: "Test complete end-to-end workflows"
    - name: "test_component_integration"
      description: "Test integration with all components"
    - name: "test_failure_scenarios"
      description: "Test various failure scenarios"

# Contract compliance
onex_compliance:
  strong_typing: true
  no_any_types: true
  pydantic_models: true
  error_chaining: true
  registry_injection: true
  workflow_coordination_patterns: true
