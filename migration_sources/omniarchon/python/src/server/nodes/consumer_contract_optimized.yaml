# Kafka Consumer Contract - Optimized Configuration
# MVP Phase 4 - Workflow 7: Performance Optimization
#
# Changes from defaults:
# - max_poll_records: 10 → 500 (50x increase for better batching)
# - max_concurrent_events: 5 → 20 (4x increase for parallelism)
# - Added fetch optimization parameters
# - Tuned session and heartbeat for stability
#
# Expected Impact:
# - Throughput: +40% (480 → 670+ ops/sec)
# - Batch efficiency: +300% (better amortization)
# - Latency: -10% (reduced per-message overhead)

name: "Archon Kafka Consumer"
version: "1.1.0-optimized"
description: "Performance-optimized Kafka consumer for codegen intelligence handlers"

# ============================================================================
# Consumer Configuration (Optimized)
# ============================================================================

consumer_config:
  # Kafka connection
  bootstrap_servers: "${KAFKA_BOOTSTRAP_SERVERS:-localhost:29092}"
  consumer_group: "archon-consumer-group"

  # Topic subscription
  topic_patterns:
    - "dev.omninode_bridge.onex.evt.*.v1"  # Subscribe to all ONEX events

  # Consumer behavior
  auto_offset_reset: "latest"  # Start from latest messages
  enable_auto_commit: true     # Auto-commit offsets
  auto_commit_interval_ms: 5000  # Commit every 5s

  # ========================================================================
  # PERFORMANCE OPTIMIZATIONS (MVP Phase 4)
  # ========================================================================

  # Polling optimization: Fetch more records per poll
  # BEFORE: 10 records/poll → HIGH overhead, low throughput
  # AFTER:  500 records/poll → LOW overhead, high throughput
  max_poll_records: 500  # ← OPTIMIZED (was 10)

  # Concurrency optimization: Process more events in parallel
  # BEFORE: 5 concurrent → LOW parallelism, high latency
  # AFTER:  20 concurrent → MEDIUM parallelism, lower latency
  # Note: Balanced with semaphore in handler (max 50 total)
  max_concurrent_events: 20  # ← OPTIMIZED (was 5)

  # Fetch optimization: Batch fetches from broker
  # Reduces network round-trips by waiting for more data
  fetch_min_bytes: 1024          # Wait for at least 1KB
  fetch_max_wait_ms: 500         # Or wait max 500ms
  fetch_max_bytes: 52428800      # Fetch up to 50MB total

  # Session and heartbeat (stability)
  # Keep defaults for reliability
  session_timeout_ms: 30000      # 30s session timeout
  heartbeat_interval_ms: 10000   # 10s heartbeat interval

  # Rebalance configuration
  max_poll_interval_ms: 300000   # 5 min max poll interval

  # ========================================================================
  # Circuit Breaker Configuration
  # ========================================================================

  circuit_breaker_enabled: true
  failure_threshold: 5           # Open circuit after 5 failures
  timeout_seconds: 60            # Wait 60s before retry

  # ========================================================================
  # Handler Configuration
  # ========================================================================

  handler_config:
    # Use optimized handlers with caching and concurrency control
    use_optimized_handlers: true

    # Handler-level concurrency limits (per handler type)
    validation_handler:
      max_concurrent: 50         # Max 50 concurrent validations
      cache_size: 1000           # Cache 1000 validation results

    analysis_handler:
      max_concurrent: 50
      cache_size: 1000

    pattern_handler:
      max_concurrent: 50
      cache_size: 500            # Smaller cache for patterns

    mixin_handler:
      max_concurrent: 50
      cache_size: 500

# ============================================================================
# Metrics and Monitoring
# ============================================================================

metrics:
  enabled: true
  collection_interval_seconds: 10
  metrics_to_track:
    - "events_processed"
    - "events_failed"
    - "processing_latency_ms"
    - "cache_hit_rate"
    - "concurrent_operations"
    - "semaphore_wait_time_ms"

# ============================================================================
# Performance Targets (MVP Phase 4)
# ============================================================================

performance_targets:
  throughput_ops_sec: 650        # Target: 650 ops/sec sustained
  p50_latency_ms: 200            # Target: 200ms p50
  p95_latency_ms: 500            # Target: 500ms p95
  p99_latency_ms: 1000           # Target: 1000ms p99
  success_rate: 0.95             # Target: 95% success rate minimum

# ============================================================================
# Optimization Notes
# ============================================================================

# Performance improvements expected:
# 1. Throughput: +40% (480 → 670 ops/sec)
# 2. Latency (cached): -70% (805ms → 240ms)
# 3. Latency (p95): -75% (2006ms → 500ms)
# 4. Success rate: 100% (from 0% failures at high load)
#
# Key optimizations:
# - Larger batch sizes reduce per-message overhead
# - Higher concurrency improves parallelism
# - Handler semaphores prevent overload
# - Caching eliminates redundant computation
# - Connection pooling prevents exhaustion
#
# Trade-offs:
# - Higher memory usage (~50-100 MB increase)
# - Longer processing time if batch fails
# - More complex error handling
#
# Monitoring:
# - Watch for memory growth
# - Monitor cache hit rates (target: >60%)
# - Track semaphore wait times (target: <50ms)
