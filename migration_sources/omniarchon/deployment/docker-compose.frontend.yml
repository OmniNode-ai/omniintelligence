# ============================================================================
# OmniArchon - Frontend Services
# ============================================================================
# Purpose: User-facing services (UI, agent orchestration)
# Dependencies: Requires docker-compose.services.yml running
# Usage: docker compose -f docker-compose.yml -f docker-compose.services.yml -f docker-compose.frontend.yml up -d
#
# Services:
# - archon-agents: AI agent orchestration (8052) - profile: agents (opt-in)
# - archon-frontend: React UI (3737) - commented out (not yet implemented in dev)
#
# This file contains optional user-facing services.
# archon-agents requires --profile agents to start.
# ============================================================================

# Project name - ensures all containers belong to omniarchon project
name: omniarchon

services:

  # AI Agents Service (ML/Reranking)
  archon-agents:
    profiles:
      - agents  # Only starts when explicitly using --profile agents
    build:
      context: ../python
      dockerfile: Dockerfile.agents
      args:
        BUILDKIT_INLINE_CACHE: 1
        ARCHON_AGENTS_PORT: ${ARCHON_AGENTS_PORT:-8052}
    container_name: archon-agents
    ports:
      - "${ARCHON_AGENTS_PORT:-8052}:${ARCHON_AGENTS_PORT:-8052}"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LOGFIRE_TOKEN: ${LOGFIRE_TOKEN:-}
      SERVICE_DISCOVERY_MODE: ${SERVICE_DISCOVERY_MODE:-docker_compose}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ARCHON_AGENTS_PORT: ${ARCHON_AGENTS_PORT:-8052}
      ARCHON_SERVER_PORT: ${ARCHON_SERVER_PORT:-8181}
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD",
          "sh",
          "-c",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:${ARCHON_AGENTS_PORT:-8052}/health'')"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Frontend Service (React UI) - Currently not in development compose
  # Uncomment and configure when frontend is ready
  # archon-frontend:
  #   build:
  #     context: ../archon-ui-main
  #     dockerfile: Dockerfile
  #   container_name: archon-frontend
  #   ports:
  #     - "${ARCHON_UI_PORT:-3737}:3737"
  #   environment:
  #     - REACT_APP_API_URL=${ARCHON_API_URL:-http://localhost:8053}
  #     - REACT_APP_ENVIRONMENT=${ENVIRONMENT:-development}
  #     - NODE_ENV=development
  #   networks:
  #     - app-network
  #   depends_on:
  #     archon-intelligence:
  #       condition: service_healthy
  #     archon-search:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3737/"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   restart: unless-stopped

networks:
  # External reference to base infrastructure network
  app-network:
    external: true
    name: omniarchon_app-network
