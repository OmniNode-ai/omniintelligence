# ============================================================================
# OmniArchon - Test Infrastructure
# ============================================================================
# Purpose: Minimal test services for automated testing in CI/CD pipelines
# Usage: docker compose -f docker-compose.test.yml up -d
#
# Services:
# - test-postgres: PostgreSQL 15 (port 5433)
# - test-qdrant: Qdrant vector DB (ports 6334/6335)
# - test-memgraph: Memgraph graph DB (ports 7688/7445)
# - test-valkey: Valkey cache (port 6380)
#
# All services use test-specific ports to avoid conflicts with development environment
# ============================================================================

# Project name - ensures all containers belong to omniarchon project
name: omniarchon

services:
  # PostgreSQL 15 Test Database
  test-postgres:
    image: postgres:15-alpine
    container_name: archon-test-postgres
    ports:
      - "${TEST_POSTGRES_PORT:-5433}:5432"
    environment:
      # PostgreSQL Configuration
      - POSTGRES_USER=${TEST_POSTGRES_USER:-archon_test}
      - POSTGRES_PASSWORD=${TEST_POSTGRES_PASSWORD:-archon_test_password_2025}
      - POSTGRES_DB=${TEST_POSTGRES_DB:-archon_test}
      - POSTGRES_HOST_AUTH_METHOD=scram-sha-256
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256

      # Performance Tuning for Tests
      - POSTGRES_MAX_CONNECTIONS=100
      - POSTGRES_SHARED_BUFFERS=128MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=512MB
      - POSTGRES_WORK_MEM=4MB
      - POSTGRES_MAINTENANCE_WORK_MEM=64MB
    volumes:
      - test_postgres_data:/var/lib/postgresql/data
      # Optional: Mount test schema initialization
      # - ./config/test-db/schema.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEST_POSTGRES_USER:-archon_test} -d ${TEST_POSTGRES_DB:-archon_test}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    restart: unless-stopped

  # Qdrant Vector Database (Test Instance)
  test-qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: archon-test-qdrant
    ports:
      - "${TEST_QDRANT_PORT:-6334}:6333"      # REST API (6333 → 6334)
      - "${TEST_QDRANT_GRPC_PORT:-6335}:6334" # gRPC (6334 → 6335)
    environment:
      # Service Configuration
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HOST=0.0.0.0
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=16

      # Storage Configuration (ephemeral for tests)
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=false  # In-memory for test speed
      - QDRANT__STORAGE__WRITE_CONSISTENCY_FACTOR=1

      # Performance Optimization for Tests
      - QDRANT__SERVICE__MAX_WORKERS=2
      - QDRANT__STORAGE__WAL__WAL_CAPACITY_MB=16

      # Logging
      - QDRANT__LOG_LEVEL=WARN  # Reduce log noise in tests
    volumes:
      - test_qdrant_data:/qdrant/storage
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:6333/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    restart: unless-stopped

  # Memgraph Database (Test Instance)
  test-memgraph:
    image: memgraph/memgraph:latest
    container_name: archon-test-memgraph
    ports:
      - "${TEST_MEMGRAPH_BOLT_PORT:-7688}:7687"  # Bolt protocol (7687 → 7688)
      - "${TEST_MEMGRAPH_HTTP_PORT:-7445}:7444"  # HTTP (7444 → 7445)
    environment:
      # Memgraph Configuration
      - MEMGRAPH_BOLT_PORT=7687
      - MEMGRAPH_HTTP_PORT=7444
      - MEMGRAPH_MEMORY_LIMIT=512  # 512MB for tests
      - MEMGRAPH_LOG_LEVEL=WARNING  # Reduce log noise

      # Test-specific settings (ephemeral)
      - MEMGRAPH_STORAGE_MODE=IN_MEMORY_TRANSACTIONAL
    volumes:
      - test_memgraph_data:/var/lib/memgraph
      # Optional: Mount test schema
      # - ./config/test-memgraph/schema.cypher:/etc/memgraph/schema.cypher:ro
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:7444/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    restart: unless-stopped

  # Valkey Cache (Test Instance)
  test-valkey:
    image: valkey/valkey:8.0-alpine
    container_name: archon-test-valkey
    ports:
      - "${TEST_VALKEY_PORT:-6380}:6379"  # Redis protocol (6379 → 6380)
    environment:
      # Security Configuration
      - VALKEY_PASSWORD=${TEST_VALKEY_PASSWORD:-archon_test_cache_2025}

      # Memory and Performance Configuration (smaller for tests)
      - VALKEY_MAXMEMORY=256mb
      - VALKEY_MAXMEMORY_POLICY=allkeys-lru
      - VALKEY_SAVE=""  # Disable RDB persistence
      - VALKEY_APPENDONLY=no  # Disable AOF for speed
      - VALKEY_TCP_BACKLOG=128
      - VALKEY_TIMEOUT=0
      - VALKEY_TCP_KEEPALIVE=60
    command: >
      valkey-server
      --requirepass ${TEST_VALKEY_PASSWORD:-archon_test_cache_2025}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --tcp-backlog 128
      --timeout 0
      --tcp-keepalive 60
      --loglevel warning
    volumes:
      - test_valkey_data:/data
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "valkey-cli", "--no-auth-warning", "-a", "${TEST_VALKEY_PASSWORD:-archon_test_cache_2025}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M
          cpus: '0.1'
    restart: unless-stopped

networks:
  test-network:
    name: archon-test-network
    driver: bridge

volumes:
  test_postgres_data:
    name: archon-test-postgres-data
    driver: local
  test_qdrant_data:
    name: archon-test-qdrant-data
    driver: local
  test_memgraph_data:
    name: archon-test-memgraph-data
    driver: local
  test_valkey_data:
    name: archon-test-valkey-data
    driver: local
