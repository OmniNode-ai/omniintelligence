# Deployment Configuration for Canary Impure Tool - Tier 3 Reference Implementation
# This configuration defines deployment strategies, environment settings,
# and infrastructure requirements for the impure/side effect canary tool.

# === DEPLOYMENT METADATA ===
deployment_name: canary_impure_tool_deployment
deployment_version: {"major": 1, "minor": 0, "patch": 0}
target_environments: ["development", "staging", "production"]
deployment_strategy: blue_green

# === CONTAINER CONFIGURATION ===
container:
  # Base image settings
  base_image: "python:3.11-slim"
  working_directory: "/app/canary_impure_tool"

  # Resource limits (highest due to side effects)
  cpu_limit: "2000m"
  memory_limit: "1Gi"
  cpu_request: "500m"
  memory_request: "512Mi"

  # Environment variables
  environment_variables:
    ONEX_NODE_NAME: "canary_impure_tool"
    ONEX_NODE_VERSION: "1.0.0"
    ONEX_NODE_TIER: "3"
    ONEX_LOG_LEVEL: "INFO"
    ONEX_METRICS_ENABLED: "true"
    ONEX_AUDIT_LOGGING: "true"
    ONEX_SANDBOX_MODE: "true"
    PYTHONPATH: "/app"

  # Health check configuration
  health_check:
    http_get:
      path: "/health"
      port: 8080
    initial_delay_seconds: 20
    period_seconds: 15
    timeout_seconds: 10
    failure_threshold: 2

  # Readiness check configuration
  readiness_check:
    http_get:
      path: "/ready"
      port: 8080
    initial_delay_seconds: 15
    period_seconds: 10
    timeout_seconds: 5
    failure_threshold: 1

# === KUBERNETES CONFIGURATION ===
kubernetes:
  # Deployment settings (limited replicas due to side effects)
  deployment:
    replicas: 1
    max_surge: 1
    max_unavailable: 0 # Ensure no downtime
    revision_history_limit: 10

  # Service configuration
  service:
    type: "ClusterIP"
    port: 8080
    target_port: 8080
    protocol: "TCP"

  # Ingress configuration
  ingress:
    enabled: false
    class: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: "/"

  # ConfigMap configuration
  config_map:
    enabled: true
    data:
      node_config.yaml: |
        # Reference to node_config.yaml content
      security_config.yaml: |
        # Reference to security_config.yaml content
      logging_config.yaml: |
        level: INFO
        format: json
        handlers: [console, audit]

# === SCALING CONFIGURATION ===
scaling:
  # Horizontal Pod Autoscaler (very limited)
  hpa:
    enabled: false # Disabled due to side effect coordination
    min_replicas: 1
    max_replicas: 2
    target_cpu_utilization: 50
    target_memory_utilization: 60

  # Vertical Pod Autoscaler
  vpa:
    enabled: true
    update_mode: "Auto"

  # Custom metrics scaling
  custom_metrics:
    enabled: true
    metrics:
      - name: "side_effect_queue_depth"
        target_value: 10
      - name: "security_violations"
        target_value: 0

# === MONITORING CONFIGURATION ===
monitoring:
  # Prometheus monitoring
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
    scrape_interval: "10s"

  # Logging configuration
  logging:
    driver: "json-file"
    options:
      max-size: "50m"
      max-file: "10"

  # Alerting rules
  alerts:
    high_error_rate:
      threshold: 1.0
      duration: "1m"
    security_violation:
      threshold: 1
      duration: "1m"
    side_effect_failure:
      threshold: 1
      duration: "1m"
    high_latency:
      threshold: 5000
      duration: "2m"
    audit_log_failure:
      threshold: 1
      duration: "1m"

# === NETWORKING CONFIGURATION ===
networking:
  # Network policies (strict for security)
  network_policy:
    enabled: true
    ingress_rules:
      - from:
          - namespace_selector:
              match_labels:
                name: "onex-system"
        ports:
          - protocol: "TCP"
            port: 8080
    egress_rules:
      - to:
          - namespace_selector:
              match_labels:
                name: "external-apis"
        ports:
          - protocol: "TCP"
            port: 443

  # Service mesh
  service_mesh:
    enabled: true
    type: "istio"
    mtls: "strict"

  # DNS configuration
  dns:
    policy: "ClusterFirst"
    config:
      searches: ["default.svc.cluster.local"]

# === SECURITY CONFIGURATION ===
security:
  # Pod security context (strict)
  pod_security_context:
    run_as_non_root: true
    run_as_user: 1000
    run_as_group: 1000
    fs_group: 1000
    seccomp_profile:
      type: "RuntimeDefault"

  # Container security context (very strict)
  container_security_context:
    allow_privilege_escalation: false
    read_only_root_filesystem: false # Allow audit logging
    capabilities:
      drop: ["ALL"]
      add: ["NET_BIND_SERVICE"] # For HTTP server

  # Service account
  service_account:
    create: true
    name: "canary-impure-tool-sa"
    annotations:
      "security.policy/sandbox": "strict"

  # RBAC configuration (minimal permissions)
  rbac:
    enabled: true
    rules:
      - api_groups: [""]
        resources: ["pods"]
        verbs: ["get", "list"]
      - api_groups: [""]
        resources: ["events"]
        verbs: ["create"]

# === STORAGE CONFIGURATION ===
storage:
  # Persistent volumes (required for audit logs)
  persistent_volumes:
    enabled: true
    storage_class: "encrypted-ssd"
    size: "50Gi"
    access_mode: "ReadWriteOnce"
    mount_path: "/app/audit"

  # Temporary storage (sandboxed)
  temp_storage:
    enabled: true
    size: "5Gi"
    mount_path: "/tmp"

  # EmptyDir volumes
  empty_dir_volumes:
    - name: "sandbox"
      mount_path: "/app/sandbox"
      size_limit: "1Gi"
    - name: "rollback"
      mount_path: "/app/rollback"
      size_limit: "2Gi"

# === ENVIRONMENT SPECIFIC CONFIGURATIONS ===
environments:
  development:
    replicas: 1
    cpu_limit: "1000m"
    memory_limit: "512Mi"
    log_level: "DEBUG"
    metrics_enabled: true
    storage_size: "20Gi"
    sandbox_mode: true

  staging:
    replicas: 1
    cpu_limit: "1500m"
    memory_limit: "768Mi"
    log_level: "INFO"
    metrics_enabled: true
    storage_size: "40Gi"
    sandbox_mode: true

  production:
    replicas: 1
    cpu_limit: "2000m"
    memory_limit: "1Gi"
    log_level: "INFO"
    metrics_enabled: true
    storage_size: "100Gi"
    sandbox_mode: true

# === BACKUP AND RECOVERY ===
backup:
  enabled: true
  schedule: "0 */2 * * *" # Every 2 hours
  retention_days: 90
  backup_storage_class: "encrypted-standard"
  encrypt_backups: true

recovery:
  rto_minutes: 60 # Recovery Time Objective
  rpo_minutes: 30 # Recovery Point Objective

# === DEPLOYMENT STRATEGIES ===
deployment_strategies:
  blue_green:
    enabled: true
    traffic_split_percentage: 0 # No traffic splitting for side effects
    promotion_timeout_minutes: 60
    rollback_on_side_effect_failure: true

  canary:
    enabled: false # Disabled for side effects

  rolling_update:
    enabled: false # Disabled for side effects
    max_surge: "0%"
    max_unavailable: "0%"

# === TESTING CONFIGURATION ===
testing:
  # Smoke tests
  smoke_tests:
    enabled: true
    timeout_seconds: 900
    endpoints:
      - path: "/health"
        expected_status: 200
      - path: "/ready"
        expected_status: 200
    side_effect_tests:
      - operation: "audit_log"
        expected_result: "success"

  # Load testing (limited for side effects)
  load_tests:
    enabled: false # Disabled due to side effects
    duration_minutes: 5
    virtual_users: 5

# === MAINTENANCE CONFIGURATION ===
maintenance:
  # Maintenance windows
  maintenance_window:
    day_of_week: "Saturday"
    start_time: "23:00"
    duration_hours: 8
    timezone: "UTC"

  # Update policies
  update_policy:
    auto_update: false
    update_window: "maintenance"
    rollback_on_failure: true
    audit_backup_before_update: true
    side_effect_rollback_plan: required

# === SIDE EFFECT MANAGEMENT ===
side_effect_management:
  # Rollback configuration
  rollback:
    enabled: true
    auto_rollback_timeout_minutes: 10
    manual_rollback_timeout_minutes: 60

  # Audit configuration
  audit:
    retention_days: 365
    compression_enabled: true
    encryption_enabled: true
    backup_schedule: "0 0 * * 0" # Weekly

  # Safety measures
  safety:
    max_side_effects_per_minute: 10
    require_confirmation_for_destructive: true
    enable_circuit_breaker: true

# === SECURITY SPECIFIC CONFIGURATION ===
security_specific:
  # Network security
  network_security:
    firewall_rules:
      - direction: "ingress"
        protocol: "tcp"
        port: 8080
        source: "cluster"
      - direction: "egress"
        protocol: "tcp"
        port: 443
        destination: "external-apis"

  # Compliance
  compliance:
    enable_soc2: true
    enable_gdpr: true
    data_classification: "restricted"

  # Vulnerability scanning
  vulnerability_scanning:
    enabled: true
    schedule: "0 6 * * *" # Daily at 6 AM
    severity_threshold: "medium"

# === METADATA ===
metadata:
  created_at: "2025-07-29"
  last_modified_at: "2025-07-29"
  author: "ONEX DevOps Team"
  description: "Deployment configuration for Tier 3 Impure/Side Effect canary tool"
  documentation_url: "https://docs.onex.ai/deployment/canary-impure"
  support_contact: "devops@onex.ai"

hash: TBD_GENERATE_AFTER_CREATION
