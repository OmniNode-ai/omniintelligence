# Archon Hybrid Pattern Scoring Alert Rules
# Comprehensive alerting for pattern learning and hybrid scoring system

groups:
  - name: hybrid_scoring_langextract_alerts
    interval: 30s
    rules:
      # Langextract High Error Rate Alert
      - alert: LangextractHighErrorRate
        expr: |
          (
            rate(langextract_errors_total[5m]) /
            rate(langextract_requests_total[5m])
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: langextract
        annotations:
          summary: "Langextract error rate exceeds 10%"
          description: "Langextract endpoint {{ $labels.endpoint }} has {{ $value }}% error rate for {{ $labels.error_type }}"
          runbook: "https://docs.archon.dev/runbooks/langextract-errors"

      # Langextract Critical Error Rate Alert
      - alert: LangextractCriticalErrorRate
        expr: |
          (
            rate(langextract_errors_total[5m]) /
            rate(langextract_requests_total[5m])
          ) * 100 > 25
        for: 2m
        labels:
          severity: critical
          service: intelligence
          component: langextract
        annotations:
          summary: "Langextract error rate exceeds 25% - CRITICAL"
          description: "Langextract endpoint {{ $labels.endpoint }} has {{ $value }}% error rate for {{ $labels.error_type }}"
          action_required: "immediate"

      # Langextract High Latency Alert
      - alert: LangextractHighLatency
        expr: |
          histogram_quantile(0.95,
            rate(langextract_request_duration_seconds_bucket[5m])
          ) > 5.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: langextract
        annotations:
          summary: "Langextract P95 latency exceeds 5 seconds"
          description: "Langextract endpoint {{ $labels.endpoint }} has P95 latency of {{ $value }}s"

      # Langextract Critical Latency Alert
      - alert: LangextractCriticalLatency
        expr: |
          histogram_quantile(0.95,
            rate(langextract_request_duration_seconds_bucket[5m])
          ) > 10.0
        for: 2m
        labels:
          severity: critical
          service: intelligence
          component: langextract
        annotations:
          summary: "Langextract P95 latency exceeds 10 seconds - CRITICAL"
          description: "Langextract endpoint {{ $labels.endpoint }} has P95 latency of {{ $value }}s"
          action_required: "immediate"

      # Circuit Breaker Open Alert
      - alert: LangextractCircuitBreakerOpen
        expr: langextract_circuit_breaker_state > 0
        for: 1m
        labels:
          severity: warning
          service: intelligence
          component: langextract
        annotations:
          summary: "Langextract circuit breaker opened"
          description: "Circuit breaker for endpoint {{ $labels.endpoint }} is in state {{ $value }} (1=open, 2=half-open)"

      # High Circuit Breaker Failures
      - alert: LangextractHighCircuitBreakerFailures
        expr: rate(langextract_circuit_breaker_failures_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: langextract
        annotations:
          summary: "High circuit breaker failure rate"
          description: "Endpoint {{ $labels.endpoint }} has {{ $value }} circuit breaker failures per second"

      # High Retry Rate Alert
      - alert: LangextractHighRetryRate
        expr: rate(langextract_retry_attempts_total[5m]) > 1.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: langextract
        annotations:
          summary: "High retry attempt rate detected"
          description: "Endpoint {{ $labels.endpoint }} has {{ $value }} retry attempts per second on attempt {{ $labels.attempt }}"

  - name: hybrid_scoring_cache_alerts
    interval: 30s
    rules:
      # Cache Low Hit Rate Alert
      - alert: CacheLowHitRate
        expr: semantic_cache_hit_rate < 0.6
        for: 10m
        labels:
          severity: warning
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Semantic cache hit rate below 60%"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for more than 10 minutes"
          runbook: "https://docs.archon.dev/runbooks/cache-tuning"

      # Cache Critical Hit Rate Alert
      - alert: CacheCriticalHitRate
        expr: semantic_cache_hit_rate < 0.4
        for: 5m
        labels:
          severity: critical
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Semantic cache hit rate below 40% - CRITICAL"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for more than 5 minutes"
          action_required: "immediate"

      # Cache High Memory Usage
      - alert: CacheHighMemoryUsage
        expr: semantic_cache_memory_usage_bytes > 1073741824  # 1GB
        for: 10m
        labels:
          severity: warning
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Semantic cache memory usage exceeds 1GB"
          description: "Cache memory usage is {{ $value | humanize1024 }} for more than 10 minutes"

      # Cache Excessive Evictions
      - alert: CacheExcessiveEvictions
        expr: rate(semantic_cache_evictions_total[5m]) > 10
        for: 10m
        labels:
          severity: warning
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "High cache eviction rate detected"
          description: "Cache eviction rate is {{ $value }} evictions/second for more than 10 minutes"

      # Cache Slow Lookup
      - alert: CacheSlowLookup
        expr: |
          histogram_quantile(0.95,
            rate(semantic_cache_lookup_duration_seconds_bucket[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Cache lookup P95 latency exceeds 100ms"
          description: "Cache lookup P95 latency is {{ $value }}s for more than 5 minutes"

  - name: hybrid_scoring_performance_alerts
    interval: 30s
    rules:
      # Hybrid Scoring High Latency
      - alert: HybridScoringHighLatency
        expr: |
          histogram_quantile(0.99,
            rate(hybrid_scoring_duration_seconds_bucket[5m])
          ) > 3.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: hybrid_scoring
        annotations:
          summary: "Hybrid scoring P99 latency exceeds 3 seconds"
          description: "Hybrid scoring strategy {{ $labels.scoring_strategy }} has P99 latency of {{ $value }}s"
          runbook: "https://docs.archon.dev/runbooks/scoring-performance"

      # Hybrid Scoring Critical Latency
      - alert: HybridScoringCriticalLatency
        expr: |
          histogram_quantile(0.99,
            rate(hybrid_scoring_duration_seconds_bucket[5m])
          ) > 5.0
        for: 2m
        labels:
          severity: critical
          service: intelligence
          component: hybrid_scoring
        annotations:
          summary: "Hybrid scoring P99 latency exceeds 5 seconds - CRITICAL"
          description: "Hybrid scoring strategy {{ $labels.scoring_strategy }} has P99 latency of {{ $value }}s"
          action_required: "immediate"

      # Hybrid Scoring High Error Rate
      - alert: HybridScoringHighErrorRate
        expr: |
          (
            rate(hybrid_scoring_requests_total{status="error"}[5m]) /
            rate(hybrid_scoring_requests_total[5m])
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: hybrid_scoring
        annotations:
          summary: "Hybrid scoring error rate exceeds 5%"
          description: "Hybrid scoring strategy {{ $labels.scoring_strategy }} has {{ $value }}% error rate"

      # Pattern Matching High Candidate Count
      - alert: PatternMatchingHighCandidates
        expr: |
          histogram_quantile(0.95,
            rate(pattern_matching_candidates_count_bucket[5m])
          ) > 250
        for: 10m
        labels:
          severity: warning
          service: intelligence
          component: pattern_matching
        annotations:
          summary: "Pattern matching evaluating excessive candidates"
          description: "P95 candidate count is {{ $value }} for more than 10 minutes, may impact performance"

      # Pattern Matching Slow Performance
      - alert: PatternMatchingSlowPerformance
        expr: |
          histogram_quantile(0.95,
            rate(pattern_matching_duration_seconds_bucket[5m])
          ) > 10.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: pattern_matching
        annotations:
          summary: "Pattern matching P95 duration exceeds 10 seconds"
          description: "Pattern matching P95 duration is {{ $value }}s for more than 5 minutes"

  - name: hybrid_scoring_similarity_alerts
    interval: 60s
    rules:
      # Semantic Similarity Computation Slow
      - alert: SemanticSimilarityComputationSlow
        expr: |
          histogram_quantile(0.95,
            rate(semantic_similarity_computation_seconds_bucket[5m])
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: similarity_computation
        annotations:
          summary: "Semantic similarity computation P95 exceeds 1 second"
          description: "Semantic similarity computation for method {{ $labels.method }} has P95 of {{ $value }}s"

      # Structural Similarity Computation Slow
      - alert: StructuralSimilarityComputationSlow
        expr: |
          histogram_quantile(0.95,
            rate(structural_similarity_computation_seconds_bucket[5m])
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service: intelligence
          component: similarity_computation
        annotations:
          summary: "Structural similarity computation P95 exceeds 1 second"
          description: "Structural similarity computation for method {{ $labels.method }} has P95 of {{ $value }}s"

      # Low Pattern Similarity Scores (Potential Quality Issue)
      - alert: LowPatternSimilarityScores
        expr: |
          (
            rate(pattern_similarity_score_bucket{le="0.3"}[10m]) /
            rate(pattern_similarity_score_count[10m])
          ) * 100 > 50
        for: 15m
        labels:
          severity: info
          service: intelligence
          component: pattern_quality
        annotations:
          summary: "High proportion of low similarity scores detected"
          description: "More than 50% of similarity scores for {{ $labels.similarity_type }} are below 0.3, may indicate pattern quality issues"

  - name: hybrid_scoring_system_alerts
    interval: 60s
    rules:
      # No Recent Pattern Matching Activity
      - alert: NoPatternMatchingActivity
        expr: |
          rate(hybrid_scoring_requests_total[5m]) == 0
        for: 15m
        labels:
          severity: warning
          service: intelligence
          component: pattern_learning
        annotations:
          summary: "No pattern matching activity detected"
          description: "No hybrid scoring requests in the last 15 minutes, system may be idle or experiencing issues"

      # High Active Sessions
      - alert: HighActivePatternLearningSessions
        expr: active_pattern_learning_sessions > 50
        for: 10m
        labels:
          severity: warning
          service: intelligence
          component: pattern_learning
        annotations:
          summary: "High number of active pattern learning sessions"
          description: "Active pattern learning sessions count is {{ $value }} for more than 10 minutes"

      # Pattern Database Size Warning
      - alert: PatternDatabaseSizeHigh
        expr: pattern_database_size_entries > 100000
        for: 1h
        labels:
          severity: info
          service: intelligence
          component: pattern_database
        annotations:
          summary: "Pattern database size exceeds 100k entries"
          description: "Pattern database has {{ $value }} entries, consider archiving or optimization"

  - name: hybrid_scoring_predictive_alerts
    interval: 300s  # Run every 5 minutes
    rules:
      # Predictive Cache Hit Rate Degradation
      - alert: CacheHitRateTrendingDown
        expr: |
          predict_linear(semantic_cache_hit_rate[1h], 2 * 3600) < 0.5
        for: 10m
        labels:
          severity: info
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Cache hit rate trending down"
          description: "Cache hit rate is predicted to drop below 50% in 2 hours based on current trend"

      # Predictive Latency Increase
      - alert: HybridScoringLatencyTrendingUp
        expr: |
          predict_linear(
            hybrid_scoring_duration_seconds_sum[1h],
            2 * 3600
          ) > 5.0
        for: 15m
        labels:
          severity: info
          service: intelligence
          component: hybrid_scoring
        annotations:
          summary: "Hybrid scoring latency trending up"
          description: "P95 latency for {{ $labels.scoring_strategy }} is predicted to exceed 5s in 2 hours based on current trend"

      # Predictive Memory Usage Growth
      - alert: CacheMemoryUsageTrendingUp
        expr: |
          predict_linear(semantic_cache_memory_usage_bytes[2h], 4 * 3600) > 2147483648  # 2GB
        for: 30m
        labels:
          severity: info
          service: intelligence
          component: semantic_cache
        annotations:
          summary: "Cache memory usage trending high"
          description: "Cache memory usage is predicted to exceed 2GB in 4 hours based on current trend"
