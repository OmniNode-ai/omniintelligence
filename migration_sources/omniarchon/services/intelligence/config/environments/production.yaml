# Production Environment Quality Gates Configuration
# Version: 1.0
# Purpose: Strictest validation for production deployments

version: "1.0"
environment: "production"
description: "Production environment with strictest quality gates and zero tolerance for critical issues"

# Override global settings for production
global:
  enabled: true
  fail_fast: true  # Stop immediately on critical failures
  parallel_execution: true
  timeout_seconds: 180  # Strict timeout
  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 10
  notifications:
    enabled: true
    channels:
      - slack
      - email
    on_failure: true
    on_success: true  # Notify on success in prod

# Production-specific gate overrides - STRICTEST SETTINGS
quality_gates:

  onex_compliance:
    enabled: true
    priority: 1
    blocking: true
    threshold: 0.95  # 95% compliance required
    description: "Zero tolerance for architectural violations in production"
    rules:
      naming_conventions:
        strictness: "strict"
      contract_usage:
        required: true
      node_types:
        enforced: true
      architecture_patterns:
        validated: true
      anti_patterns:
        max_violations: 0  # Zero tolerance

  test_coverage:
    enabled: true
    priority: 2
    blocking: true
    threshold: 0.90  # 90% overall coverage
    coverage_types:
      line_coverage:
        threshold: 0.90
      branch_coverage:
        threshold: 0.85
      function_coverage:
        threshold: 0.95
    critical_paths:
      threshold: 1.0  # 100% coverage for critical paths
    requirements:
      unit_tests: true
      integration_tests: true
      performance_tests: true
      min_assertions_per_test: 1

  code_quality:
    enabled: true
    priority: 3
    blocking: true
    threshold: 0.70  # Minimum 70% quality score
    checks:
      complexity:
        metrics:
          cyclomatic_complexity:
            threshold: 10  # Strict limit
          cognitive_complexity:
            threshold: 15  # Strict limit
          max_function_lines:
            threshold: 50
          max_class_lines:
            threshold: 300
      duplication:
        max_percentage: 5.0  # Max 5% duplication
        min_duplicate_lines: 6
      maintainability:
        min_grade: "B"  # Minimum B grade
      code_smells:
        max_smells: 10
        severity_threshold: "medium"
      documentation:
        enabled: true
        requirements:
          public_functions: true
          public_classes: true
          complex_logic: true
      type_hints:
        required: true
        coverage_threshold: 0.95

  performance:
    enabled: true
    priority: 4
    blocking: true  # Block on performance regressions
    thresholds:
      pattern_extraction:
        max_duration_ms: 200
        percentile: 95
        severity: "high"
      vector_search:
        max_duration_ms: 100
        percentile: 95
        severity: "high"
      storage_query:
        max_duration_ms: 50
        percentile: 95
        severity: "high"
      api_endpoint:
        max_duration_ms: 500
        percentile: 99
        severity: "high"
    metrics:
      cpu_usage:
        max_percentage: 75  # Stricter than default
      memory_usage:
        max_mb: 1024
        leak_detection: true
      cache_hit_rate:
        min_percentage: 75  # Higher than default
    regression_detection:
      enabled: true
      baseline_comparison: true
      max_degradation_percentage: 15  # Strict regression threshold
      measurement_window: "7d"
    load_testing:
      enabled: true
      concurrent_users: 100
      duration_seconds: 300
      success_rate_threshold: 0.995  # 99.5% success rate

  security:
    enabled: true
    priority: 5
    blocking: true
    severity_threshold: "medium"  # Block on medium+ severity
    scans:
      dependency_vulnerabilities:
        enabled: true
        severity_levels:
          critical: 0  # Zero tolerance
          high: 0      # Zero tolerance
          medium: 0    # Zero tolerance in prod
          low: 10      # Minimal low severity allowed
      code_vulnerabilities:
        enabled: true
        checks:
          - sql_injection
          - command_injection
          - path_traversal
          - insecure_random
          - hardcoded_secrets
          - weak_crypto
      secret_detection:
        enabled: true
        tools:
          - "detect-secrets"
          - "trufflehog"
      license_compliance:
        enabled: true
        allowed_licenses:
          - "MIT"
          - "Apache-2.0"
          - "BSD-3-Clause"
          - "BSD-2-Clause"
          - "ISC"
      container_security:
        enabled: true
        base_image_scanning: true
        vulnerability_threshold: "high"
    compliance:
      enabled: true
      standards:
        - "OWASP-Top-10"
        - "CWE-Top-25"

  multi_model_consensus:
    enabled: true
    priority: 6
    blocking: true
    consensus_threshold: 0.67  # 2 of 3 models must agree
    models:
      - name: "gemini-pro"
        weight: 1.0
        enabled: true
      - name: "codestral"
        weight: 1.5
        enabled: true
      - name: "deepseek"
        weight: 2.0
        enabled: true
    apply_to:
      architecture_decisions:
        enabled: true
        min_consensus: 0.80  # Higher threshold for prod
      critical_code_changes:
        enabled: true
        min_consensus: 0.80  # Higher threshold for prod
      refactoring:
        enabled: true
        min_consensus: 0.67
    timeout_seconds: 120
    retry_on_failure: true
    max_retries: 2

# Strict exemption rules for production
exemptions:
  enabled: true
  require_justification: true
  require_approval: true
  approval_process:
    approvers:
      - "tech_lead"
      - "principal_engineer"
      - "security_lead"
    min_approvals: 2  # Require 2 approvals in prod
    approval_timeout_hours: 24
  valid_reasons:
    - id: "emergency_hotfix"
      description: "Critical production hotfix"
      requires_timeline: true
      requires_ticket: true
      max_duration_days: 7
    - id: "security_patch"
      description: "Emergency security patch"
      requires_documentation: true
      requires_ticket: true
      max_duration_days: 3
  tracking:
    enabled: true
    storage: "database"
    review_frequency_days: 7  # Weekly review in prod
    automatic_expiration: true

# Comprehensive notifications for production
notifications:
  channels:
    slack:
      enabled: true
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channels:
        failures: "#production-alerts"
        success: "#production-updates"
        exemptions: "#production-exemptions"
    email:
      enabled: true
      recipients:
        failures:
          - "team-lead@archon.dev"
          - "quality@archon.dev"
          - "oncall@archon.dev"
        exemptions:
          - "tech-lead@archon.dev"
          - "principal@archon.dev"
  templates:
    failure:
      subject: "üö® PRODUCTION Quality Gate Failure: {gate_name}"
      include_details: true
      include_remediation: true
      priority: "high"
    exemption_request:
      subject: "‚ö†Ô∏è PRODUCTION Quality Gate Exemption Request: {gate_name}"
      include_justification: true
      include_timeline: true
      require_immediate_review: true

# Comprehensive reporting for production
reporting:
  enabled: true
  frequency: "daily"
  formats:
    - "json"
    - "html"
    - "markdown"
    - "pdf"
  metrics:
    - gate_pass_rate
    - gate_failure_rate
    - exemption_rate
    - avg_execution_time
    - trend_analysis
    - sla_compliance
    - security_posture
  dashboards:
    - url: "http://localhost:3000/quality-gates"
      refresh_interval_seconds: 30
  alerts:
    - threshold: 0.95  # Alert if pass rate drops below 95%
      severity: "critical"
      notification: "immediate"

metadata:
  last_reviewed: "2025-10-02"
  next_review: "2025-10-16"  # Bi-weekly review for prod
  maintainer: "Archon Production Quality Team"
  sla_commitment: "99.9% quality gate pass rate"
  notes: "Production environment with zero tolerance for critical issues and comprehensive monitoring"
