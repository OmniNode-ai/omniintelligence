# Staging Environment Quality Gates Configuration
# Version: 1.0
# Purpose: Production-like validation with some relaxations for testing

version: "1.0"
environment: "staging"
description: "Staging environment with near-production quality gates for final validation"

# Override global settings for staging
global:
  enabled: true
  fail_fast: false
  parallel_execution: true
  timeout_seconds: 300
  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
  notifications:
    enabled: true
    channels:
      - slack
    on_failure: true
    on_success: false

# Staging-specific gate overrides
quality_gates:

  onex_compliance:
    enabled: true
    blocking: true  # Block on compliance failures
    threshold: 0.90  # Slightly relaxed from prod (0.95)
    rules:
      naming_conventions:
        strictness: "strict"
      contract_usage:
        required: true
      anti_patterns:
        max_violations: 2  # Allow minimal violations

  test_coverage:
    enabled: true
    blocking: true
    threshold: 0.85  # Slightly relaxed from prod (0.90)
    coverage_types:
      line_coverage:
        threshold: 0.85
      branch_coverage:
        threshold: 0.80
      function_coverage:
        threshold: 0.90
    critical_paths:
      threshold: 0.95  # Near-production requirement

  code_quality:
    enabled: true
    blocking: true
    threshold: 0.65  # Slightly relaxed from prod (0.70)
    checks:
      complexity:
        metrics:
          cyclomatic_complexity:
            threshold: 12  # Slightly higher than prod
          cognitive_complexity:
            threshold: 17
          max_function_lines:
            threshold: 60
      duplication:
        max_percentage: 7.0  # Slightly higher than prod
      maintainability:
        min_grade: "B"
      code_smells:
        max_smells: 15  # More lenient than prod

  performance:
    enabled: true
    blocking: true  # Block on performance issues in staging
    thresholds:
      pattern_extraction:
        max_duration_ms: 250  # Slightly relaxed
      vector_search:
        max_duration_ms: 120  # Slightly relaxed
      storage_query:
        max_duration_ms: 75  # Slightly relaxed
      api_endpoint:
        max_duration_ms: 600  # Slightly relaxed
    regression_detection:
      enabled: true
      max_degradation_percentage: 25  # More lenient
    load_testing:
      enabled: true
      concurrent_users: 50  # Half of production
      duration_seconds: 180
      success_rate_threshold: 0.98

  security:
    enabled: true
    blocking: true
    severity_threshold: "medium"
    scans:
      dependency_vulnerabilities:
        severity_levels:
          critical: 0
          high: 0
          medium: 3  # Allow few medium in staging
          low: 15
      code_vulnerabilities:
        enabled: true
      secret_detection:
        enabled: true
      license_compliance:
        enabled: true
      container_security:
        enabled: true  # Test container security in staging

  multi_model_consensus:
    enabled: true
    blocking: true
    consensus_threshold: 0.67
    apply_to:
      architecture_decisions:
        enabled: true
        min_consensus: 0.67
      critical_code_changes:
        enabled: true
        min_consensus: 0.75  # Slightly lower than prod
      refactoring:
        enabled: true
        min_consensus: 0.60  # More lenient

# Moderate exemption rules for staging
exemptions:
  enabled: true
  require_justification: true
  require_approval: true
  approval_process:
    approvers:
      - "tech_lead"
    min_approvals: 1
    approval_timeout_hours: 12  # Faster than prod

# Full notifications for staging
notifications:
  channels:
    slack:
      enabled: true
      channels:
        failures: "#staging-alerts"
        success: "#staging-updates"
        exemptions: "#staging-exemptions"
    email:
      enabled: true
      recipients:
        failures: ["staging-team@archon.dev"]

reporting:
  enabled: true
  frequency: "daily"
  formats:
    - "json"
    - "html"
    - "markdown"
  metrics:
    - gate_pass_rate
    - gate_failure_rate
    - exemption_rate
    - avg_execution_time
    - trend_analysis

metadata:
  last_reviewed: "2025-10-02"
  notes: "Staging environment for final validation before production deployment"
