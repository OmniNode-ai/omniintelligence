# Quality Gates Configuration
# Version: 1.0
# Purpose: Define quality gate rules, thresholds, and behaviors for Intelligence Service
# AI Automation: 30% AI-generated + 70% human business rules

version: "1.0"
updated_at: "2025-10-02"
description: "Comprehensive quality gate configuration for code quality, performance, and compliance validation"

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================
global:
  enabled: true
  fail_fast: false  # Continue checking all gates even if one fails
  parallel_execution: true
  timeout_seconds: 300
  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
  notifications:
    enabled: true
    channels:
      - slack
      - email
    on_failure: true
    on_success: false  # Only notify on failures by default

# =============================================================================
# QUALITY GATES
# =============================================================================
quality_gates:

  # ---------------------------------------------------------------------------
  # ONEX COMPLIANCE GATE
  # ---------------------------------------------------------------------------
  onex_compliance:
    enabled: true
    priority: 1  # Highest priority - architectural foundation
    blocking: true
    threshold: 0.95  # 95% compliance required
    description: "Validates adherence to ONEX architectural patterns and naming conventions"

    rules:
      naming_conventions:
        enabled: true
        strictness: "strict"
        patterns:
          classes:
            effect: "^Node[A-Z][a-zA-Z]*Effect$"
            compute: "^Node[A-Z][a-zA-Z]*Compute$"
            reducer: "^Node[A-Z][a-zA-Z]*Reducer$"
            orchestrator: "^Node[A-Z][a-zA-Z]*Orchestrator$"
          files:
            effect: "^node_[a-z_]*_effect\\.py$"
            compute: "^node_[a-z_]*_compute\\.py$"
            reducer: "^node_[a-z_]*_reducer\\.py$"
            orchestrator: "^node_[a-z_]*_orchestrator\\.py$"
          models: "^Model[A-Z][a-zA-Z]*$"
          enums: "^Enum[A-Z][a-zA-Z]*$"
          contracts: "^ModelContract[A-Z][a-zA-Z]*$"

      contract_usage:
        enabled: true
        required: true
        validation:
          - all_nodes_must_have_contracts: true
          - contract_type_matches_node_type: true
          - contract_versioning: true
          - contract_inheritance: true

      node_types:
        enabled: true
        enforced: true
        valid_types:
          - effect
          - compute
          - reducer
          - orchestrator
        validation:
          - single_responsibility: true
          - correct_base_class: true
          - proper_method_signatures: true

      architecture_patterns:
        enabled: true
        validated: true
        required_patterns:
          - dependency_injection: true
          - async_await: true
          - transaction_management: true
          - error_handling: true
          - logging_integration: true

      anti_patterns:
        detection: true
        blocking: true
        max_violations: 0
        patterns:
          - mixed_node_responsibilities
          - synchronous_blocking_io
          - direct_database_access_in_compute
          - missing_error_handling
          - hardcoded_dependencies

    exemptions:
      allowed: true
      require_justification: true
      approval_required: true
      max_per_file: 2
      valid_reasons:
        - "legacy_code_migration"
        - "third_party_integration"
        - "performance_critical_path"
        - "temporary_workaround"

  # ---------------------------------------------------------------------------
  # TEST COVERAGE GATE
  # ---------------------------------------------------------------------------
  test_coverage:
    enabled: true
    priority: 2
    blocking: true
    threshold: 0.90  # 90% coverage required
    description: "Ensures comprehensive test coverage across all code paths"

    coverage_types:
      line_coverage:
        enabled: true
        threshold: 0.90
      branch_coverage:
        enabled: true
        threshold: 0.85
      function_coverage:
        enabled: true
        threshold: 0.95

    exclude_patterns:
      - "*/tests/*"
      - "*/test_*.py"
      - "*/__init__.py"
      - "*/migrations/*"
      - "*/scripts/*"
      - "*/config/*"
      - "*/.venv/*"
      - "*/node_modules/*"

    include_patterns:
      - "*/src/**/*.py"
      - "*/app/**/*.py"

    critical_paths:
      enabled: true
      threshold: 1.0  # 100% coverage for critical paths
      paths:
        - "*/src/services/pattern_learning/**/*.py"
        - "*/src/services/quality_assessment/**/*.py"
        - "*/src/intelligence/**/*.py"

    requirements:
      unit_tests: true
      integration_tests: true
      performance_tests: true
      min_assertions_per_test: 1

    exemptions:
      allowed: true
      require_justification: true
      approval_required: true

  # ---------------------------------------------------------------------------
  # CODE QUALITY GATE
  # ---------------------------------------------------------------------------
  code_quality:
    enabled: true
    priority: 3
    blocking: true
    threshold: 0.70  # 70% quality score minimum
    description: "Validates code quality metrics including complexity, duplication, and maintainability"

    checks:
      complexity:
        enabled: true
        metrics:
          cyclomatic_complexity:
            threshold: 10
            severity: "high"
          cognitive_complexity:
            threshold: 15
            severity: "high"
          max_function_lines:
            threshold: 50
            severity: "medium"
          max_class_lines:
            threshold: 300
            severity: "medium"

      duplication:
        enabled: true
        max_percentage: 5.0  # Max 5% code duplication
        min_duplicate_lines: 6
        ignore_patterns:
          - "*/tests/*"
          - "*/migrations/*"

      maintainability:
        enabled: true
        min_grade: "B"  # A, B, C, D, F grading scale
        factors:
          - code_complexity
          - code_duplication
          - documentation_coverage
          - naming_quality

      code_smells:
        enabled: true
        max_smells: 10
        severity_threshold: "medium"
        types:
          - long_method
          - long_parameter_list
          - large_class
          - feature_envy
          - data_clumps

      documentation:
        enabled: true
        requirements:
          public_functions: true
          public_classes: true
          complex_logic: true
          min_docstring_length: 20

      type_hints:
        enabled: true
        required: true
        coverage_threshold: 0.95

    exemptions:
      allowed: true
      require_justification: true
      approval_required: false  # Code quality exemptions don't need approval

  # ---------------------------------------------------------------------------
  # PERFORMANCE GATE
  # ---------------------------------------------------------------------------
  performance:
    enabled: true
    priority: 4
    blocking: false  # Warning only - don't block on performance issues
    description: "Monitors performance metrics and identifies optimization opportunities"

    thresholds:
      pattern_extraction:
        max_duration_ms: 200
        percentile: 95
        severity: "medium"

      vector_search:
        max_duration_ms: 100
        percentile: 95
        severity: "high"

      storage_query:
        max_duration_ms: 50
        percentile: 95
        severity: "medium"

      api_endpoint:
        max_duration_ms: 500
        percentile: 99
        severity: "high"

      batch_processing:
        max_duration_ms: 5000
        batch_size: 100
        severity: "low"

    metrics:
      cpu_usage:
        enabled: true
        max_percentage: 80
        duration_seconds: 60

      memory_usage:
        enabled: true
        max_mb: 1024
        leak_detection: true

      database_connections:
        enabled: true
        max_active: 20
        max_idle: 5
        connection_timeout_ms: 5000

      cache_hit_rate:
        enabled: true
        min_percentage: 70
        measurement_window_seconds: 300

    regression_detection:
      enabled: true
      baseline_comparison: true
      max_degradation_percentage: 20
      measurement_window: "7d"

    load_testing:
      enabled: false  # Only in staging/prod
      concurrent_users: 100
      duration_seconds: 300
      success_rate_threshold: 0.99

  # ---------------------------------------------------------------------------
  # SECURITY GATE
  # ---------------------------------------------------------------------------
  security:
    enabled: true
    priority: 5
    blocking: true
    severity_threshold: "medium"  # Block on medium+ severity
    description: "Scans for security vulnerabilities and compliance issues"

    scans:
      dependency_vulnerabilities:
        enabled: true
        tools:
          - "safety"
          - "pip-audit"
        severity_levels:
          critical: 0
          high: 0
          medium: 5
          low: 20

      code_vulnerabilities:
        enabled: true
        tools:
          - "bandit"
          - "semgrep"
        checks:
          - sql_injection
          - command_injection
          - path_traversal
          - insecure_random
          - hardcoded_secrets
          - weak_crypto

      secret_detection:
        enabled: true
        tools:
          - "detect-secrets"
          - "trufflehog"
        patterns:
          - api_keys
          - passwords
          - tokens
          - certificates
          - connection_strings

      license_compliance:
        enabled: true
        allowed_licenses:
          - "MIT"
          - "Apache-2.0"
          - "BSD-3-Clause"
          - "BSD-2-Clause"
          - "ISC"
        blocked_licenses:
          - "GPL-3.0"
          - "AGPL-3.0"
          - "LGPL-3.0"

      container_security:
        enabled: false  # Only when containerized
        base_image_scanning: true
        vulnerability_threshold: "high"

    compliance:
      enabled: true
      standards:
        - "OWASP-Top-10"
        - "CWE-Top-25"
      validation: true

  # ---------------------------------------------------------------------------
  # MULTI-MODEL CONSENSUS GATE
  # ---------------------------------------------------------------------------
  multi_model_consensus:
    enabled: true
    priority: 6
    blocking: true
    consensus_threshold: 0.67  # 2 of 3 models must agree
    description: "Validates critical changes through multi-model AI consensus"

    models:
      - name: "gemini-pro"
        weight: 1.0
        endpoint: "${GEMINI_ENDPOINT}"
        enabled: true

      - name: "codestral"
        weight: 1.5
        endpoint: "${OLLAMA_BASE_URL}/codestral:22b-v0.1-q4_K_M"
        enabled: true

      - name: "deepseek"
        weight: 2.0
        endpoint: "${OLLAMA_BASE_URL}/deepseek-coder:33b-instruct-q4_K_M"
        enabled: true

    apply_to:
      architecture_decisions:
        enabled: true
        triggers:
          - new_node_creation
          - contract_changes
          - architectural_pattern_changes
        min_consensus: 0.67

      critical_code_changes:
        enabled: true
        triggers:
          - core_service_modifications
          - database_schema_changes
          - api_contract_changes
          - security_related_changes
        min_consensus: 0.80

      refactoring:
        enabled: true
        triggers:
          - large_scale_refactoring
          - pattern_extraction
          - code_reorganization
        min_consensus: 0.67

    validation_criteria:
      correctness: true
      best_practices: true
      performance_impact: true
      security_impact: true
      maintainability: true

    timeout_seconds: 120
    retry_on_failure: true
    max_retries: 2

# =============================================================================
# EXEMPTIONS & OVERRIDES
# =============================================================================
exemptions:
  enabled: true
  require_justification: true
  require_approval: true

  approval_process:
    approvers:
      - "tech_lead"
      - "principal_engineer"
      - "security_lead"
    min_approvals: 1
    approval_timeout_hours: 24

  valid_reasons:
    - id: "legacy_migration"
      description: "Code is part of legacy system migration"
      requires_timeline: true
      max_duration_days: 90

    - id: "third_party_integration"
      description: "Third-party library integration constraints"
      requires_documentation: true

    - id: "performance_critical"
      description: "Performance-critical code path optimization"
      requires_benchmark: true

    - id: "temporary_workaround"
      description: "Temporary workaround with planned remediation"
      requires_timeline: true
      max_duration_days: 30
      requires_ticket: true

    - id: "experimental_feature"
      description: "Experimental feature under development"
      requires_feature_flag: true
      max_duration_days: 60

  tracking:
    enabled: true
    storage: "database"
    review_frequency_days: 14
    automatic_expiration: true

# =============================================================================
# NOTIFICATIONS & REPORTING
# =============================================================================
notifications:
  channels:
    slack:
      enabled: true
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channels:
        failures: "#quality-alerts"
        success: "#quality-updates"
        exemptions: "#quality-exemptions"

    email:
      enabled: true
      smtp_host: "${SMTP_HOST}"
      smtp_port: 587
      from_address: "quality-gates@archon.dev"
      recipients:
        failures: ["team-lead@archon.dev", "quality@archon.dev"]
        exemptions: ["tech-lead@archon.dev"]

  templates:
    failure:
      subject: "Quality Gate Failure: {gate_name} - {severity}"
      include_details: true
      include_remediation: true

    exemption_request:
      subject: "Quality Gate Exemption Request: {gate_name}"
      include_justification: true
      include_timeline: true

reporting:
  enabled: true
  frequency: "daily"
  formats:
    - "json"
    - "html"
    - "markdown"

  metrics:
    - gate_pass_rate
    - gate_failure_rate
    - exemption_rate
    - avg_execution_time
    - trend_analysis

  dashboards:
    - url: "http://localhost:3000/quality-gates"
      refresh_interval_seconds: 60

# =============================================================================
# ENVIRONMENT OVERRIDES
# =============================================================================
# Environment-specific configurations can override these defaults
# See environments/ directory for environment-specific configs

environment_overrides:
  development:
    config_path: "./config/environments/development.yaml"
    description: "Relaxed thresholds for rapid development"

  staging:
    config_path: "./config/environments/staging.yaml"
    description: "Production-like validation with some relaxations"

  production:
    config_path: "./config/environments/production.yaml"
    description: "Strictest validation for production deployments"

# =============================================================================
# METADATA
# =============================================================================
metadata:
  maintainer: "Archon Quality Team"
  documentation: "https://docs.archon.dev/quality-gates"
  changelog: "./QUALITY_GATES_CHANGELOG.md"
  schema_version: "1.0"
  last_reviewed: "2025-10-02"
  next_review: "2025-11-02"
