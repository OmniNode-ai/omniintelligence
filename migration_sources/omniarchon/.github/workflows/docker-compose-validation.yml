name: Docker Compose Validation

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'refactor/**'
    paths:
      - 'deployment/**'
      - '.env.example'
      - 'docker-compose*.yml'
      - '.github/workflows/docker-compose-validation.yml'
  pull_request:
    paths:
      - 'deployment/**'
      - '.env.example'
      - 'docker-compose*.yml'
      - '.github/workflows/docker-compose-validation.yml'

jobs:
  validate:
    name: Validate Docker Compose Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify docker compose version
        run: |
          docker compose version
          echo "Docker Compose v2 is available âœ“"

      - name: Make validation script executable
        run: chmod +x scripts/validate-docker-compose.sh

      - name: Run docker-compose validation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Validating Docker Compose Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          ./scripts/validate-docker-compose.sh

      - name: Display validation summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All Docker Compose validations passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "The following checks were performed:"
          echo "  â€¢ Syntax validation (YAML parsing)"
          echo "  â€¢ Environment variable validation"
          echo "  â€¢ Hardcoded credential detection"
          echo "  â€¢ Port conflict detection"
          echo "  â€¢ Network reference validation"
          echo "  â€¢ Service dependency checks"
          echo "  â€¢ Health check presence"
          echo "  â€¢ Resource limit recommendations"
          echo ""

      - name: Display validation failure
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Docker Compose validation failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please review the errors above and fix the issues."
          echo ""
          echo "Common issues:"
          echo "  â€¢ Syntax errors in YAML files"
          echo "  â€¢ Hardcoded credentials (use environment variables)"
          echo "  â€¢ Port conflicts between services"
          echo "  â€¢ Missing required environment variables"
          echo ""
          echo "Run locally to debug:"
          echo "  ./scripts/validate-docker-compose.sh --verbose"
          echo ""
          exit 1

  validate-env:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make validation script executable
        run: chmod +x scripts/validate-env.sh

      - name: Validate .env.example
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Validating Environment Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          ./scripts/validate-env.sh .env.example || true
          echo ""
          echo "Note: Some validation checks may show warnings for .env.example"
          echo "This is expected as .env.example contains template values"
