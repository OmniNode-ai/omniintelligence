name: intelligence_api_effect
version:
  major: 1
  minor: 0
  patch: 0

description: |
  Effect node for exposing intelligence operations via REST API.
  Provides external interface for quality scores, pattern queries, and entity searches.
  Handles API request/response transformation.

node_type: effect
base_class: NodeOmniAgentEffect

# Input/Output models
input_model:
  name: ModelIntelligenceApiInput
  fields:
    endpoint:
      type: str
      required: true
      description: API endpoint path (e.g., /quality/store, /patterns/search)

    method:
      type: str
      required: true
      description: HTTP method (GET, POST, PUT, DELETE)

    payload:
      type: dict
      required: false
      description: Request payload

    query_params:
      type: dict
      required: false
      description: Query parameters

    headers:
      type: dict
      required: false
      description: Custom headers

    correlation_id:
      type: str
      required: true
      description: Correlation ID for tracing

output_model:
  name: ModelIntelligenceApiOutput
  fields:
    success:
      type: bool
      required: true
      description: Whether API call succeeded

    status_code:
      type: int
      required: true
      description: HTTP status code

    response_data:
      type: dict
      required: false
      description: Response data

    error:
      type: str
      required: false
      description: Error message if failed

# Configuration
config_model:
  name: ModelIntelligenceApiConfig
  fields:
    api_base_url:
      type: str
      required: true
      description: Base URL for intelligence API

    enable_auth:
      type: bool
      default: true
      description: Enable API authentication

    auth_token:
      type: str
      required: false
      description: Authentication token

    timeout_seconds:
      type: int
      default: 30
      description: Request timeout

    retry_on_failure:
      type: bool
      default: true
      description: Retry failed requests

    max_retries:
      type: int
      default: 3
      description: Maximum retry attempts

# Operations
operations:
  store_quality_assessment:
    description: Store quality assessment results
    endpoint: /quality/store
    method: POST
    input:
      file_path: str
      quality_score: dict
      compliance: dict
      recommendations: list
    output:
      success: bool
      stored_id: str

  query_patterns:
    description: Query patterns by criteria
    endpoint: /patterns/query
    method: GET
    input:
      project_name: str
      pattern_type: str
      min_confidence: float
    output:
      patterns: list[dict]

  search_entities:
    description: Search for code entities
    endpoint: /entities/search
    method: GET
    input:
      query: str
      entity_types: list[str]
      limit: int
    output:
      entities: list[dict]

  get_quality_report:
    description: Get quality report for file
    endpoint: /quality/report
    method: GET
    input:
      file_path: str
    output:
      report: dict

  get_pattern_matches:
    description: Get pattern matches for code
    endpoint: /patterns/matches
    method: POST
    input:
      code_snippet: str
      project_name: str
    output:
      matches: list[dict]

  get_entity_relationships:
    description: Get relationships for an entity
    endpoint: /entities/relationships
    method: GET
    input:
      entity_id: str
      depth: int
    output:
      relationships: list[dict]

  store_analysis_result:
    description: Store generic analysis result
    endpoint: /analysis/store
    method: POST
    input:
      analysis_type: str
      results: dict
    output:
      success: bool
      result_id: str

# API endpoints
endpoints:
  quality:
    - path: /quality/store
      method: POST
      description: Store quality assessment
      auth_required: true

    - path: /quality/report
      method: GET
      description: Get quality report
      auth_required: false

    - path: /quality/batch
      method: POST
      description: Batch quality assessment
      auth_required: true

  patterns:
    - path: /patterns/query
      method: GET
      description: Query patterns
      auth_required: false

    - path: /patterns/search
      method: POST
      description: Search patterns
      auth_required: false

    - path: /patterns/matches
      method: POST
      description: Get pattern matches
      auth_required: false

    - path: /patterns/lineage
      method: GET
      description: Get pattern lineage
      auth_required: false

  entities:
    - path: /entities/search
      method: GET
      description: Search entities
      auth_required: false

    - path: /entities/relationships
      method: GET
      description: Get entity relationships
      auth_required: false

    - path: /entities/details
      method: GET
      description: Get entity details
      auth_required: false

  analysis:
    - path: /analysis/store
      method: POST
      description: Store analysis results
      auth_required: true

    - path: /analysis/status
      method: GET
      description: Get analysis status
      auth_required: false

# Request/Response transformation
transformations:
  request:
    - add_correlation_id_header
    - add_timestamp_header
    - add_auth_token_if_enabled
    - serialize_payload_to_json

  response:
    - parse_json_response
    - extract_error_message
    - log_response_metrics

# Error handling
error_handling:
  on_timeout:
    action: retry_with_backoff
    max_retries: 3
    backoff_seconds: [2, 4, 8]

  on_4xx_error:
    action: log_and_fail
    retry: false

  on_5xx_error:
    action: retry_with_backoff
    max_retries: 3
    backoff_seconds: [2, 4, 8]

  on_network_error:
    action: retry_with_backoff
    max_retries: 5
    backoff_seconds: [1, 2, 4, 8, 16]

# Rate limiting
rate_limiting:
  enabled: true
  requests_per_second: 100
  burst_size: 50

# Caching
caching:
  enabled: true
  cache_get_requests: true
  cache_ttl_seconds: 300
  cache_key_template: "api:{endpoint}:{query_hash}"

# Dependencies
dependencies:
  external_services:
    - intelligence_api

# Metadata
metadata:
  author: omniintelligence
  created_at: "2025-11-14"
  tags:
    - effect
    - api
    - rest
    - external-interface
    - http
