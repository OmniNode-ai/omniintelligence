---
# ONEX Node Contract - Intelligence Adapter Effect Node
#
# This effect node adapts between Kafka events and Archon intelligence services.
# Consumes CODE_ANALYSIS_REQUESTED events and publishes completion/failure events.
# =============================================================================
#
# =============================================================================
# TODO(#16): Consider splitting this adapter into smaller, focused adapters
# =============================================================================
# Status: Future consideration (v2.0) - current implementation is functional
# Issue: https://github.com/OmniNode-ai/omniintelligence/issues/16
#
# This adapter currently handles multiple responsibilities (quality assessment,
# pattern detection, performance analysis). For better single-responsibility
# adherence, consider decomposing into:
#   - quality_adapter: Quality assessment and ONEX compliance
#   - pattern_adapter: Pattern detection and matching
#   - performance_adapter: Performance analysis and optimization
#
# See ARCHITECTURE.md in this directory for detailed analysis and tradeoffs.
# =============================================================================
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version:
  major: 1
  minor: 0
  patch: 0
name: "intelligence_adapter"
node_type: "EFFECT_GENERIC"
description: >-
  Effect node that adapts between Kafka events and Archon intelligence services. Consumes code analysis
  requests and publishes completion/failure events with DLQ routing support.
# Note: Input/output models use top-level module "omniintelligence.models" rather than
# node-specific "omniintelligence.nodes.intelligence_adapter.models" because these are
# shared models used across multiple intelligence nodes (adapter, orchestrator, etc.).
# See omniintelligence/models/__init__.py for migration documentation.
input_model:
  name: "ModelIntelligenceInput"
  module: "omniintelligence.models"
  description: "Input containing operation type, content, and analysis parameters."
output_model:
  name: "ModelIntelligenceOutput"
  module: "omniintelligence.models"
  description: "Output containing analysis results, scores, and recommendations."
# Consumed Events
# ===============
# Event payload models are defined in omniintelligence.models.events
# (migrated from inline stubs as part of OMN-1437).
consumed_events:
  - topic: "{env}.archon-intelligence.intelligence.code-analysis-requested.v1"
    event_type: "CodeAnalysisRequested"
    payload_model: "ModelCodeAnalysisRequestPayload"
    payload_module: "omniintelligence.models.events"
    description: "Code analysis request from external services"
# Published Events
# ================
published_events:
  - topic: "{env}.archon-intelligence.intelligence.code-analysis-completed.v1"
    event_type: "CodeAnalysisCompleted"
    payload_model: "ModelCodeAnalysisCompletedPayload"
    payload_module: "omniintelligence.models.events"
    description: "Code analysis completed successfully"
  - topic: "{env}.archon-intelligence.intelligence.code-analysis-failed.v1"
    event_type: "CodeAnalysisFailed"
    payload_model: "ModelCodeAnalysisFailedPayload"
    payload_module: "omniintelligence.models.events"
    description: "Code analysis failed"
# Handler Routing Configuration
# =============================
# Routes incoming events to handlers based on payload type.
# Handlers return ModelHandlerOutput.for_effect() with events to publish.
# Runtime handles the actual event publishing.
#
# Architecture:
#   1. Runtime subscribes to consumed_events topics
#   2. Runtime extracts payload and matches to handler via routing_key
#   3. Handler processes payload, returns ModelHandlerOutput.for_effect(events=...)
#   4. Runtime publishes returned events to published_events topics
#
handler_routing:
  version:
    major: 1
    minor: 0
    patch: 0
  routing_strategy: payload_type_match
  handlers:
    # CODE_ANALYSIS_REQUESTED event -> HandlerCodeAnalysisRequested
    - routing_key: ModelCodeAnalysisRequestPayload
      handler_key: handler_code_analysis_requested
      message_category: event
      priority: 0
      output_events:
        - ModelCodeAnalysisCompletedPayload
        - ModelCodeAnalysisFailedPayload
  default_handler: handler_unknown_event
  execution_mode: sequential
# Error Handling Configuration
# ============================
error_handling:
  retry_policy:
    max_retries: 3
    initial_delay_ms: 1000
    max_delay_ms: 30000
    exponential_base: 2
    retry_on:
      - "ConnectionError"
      - "TimeoutError"
      - "ServiceUnavailableError"
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    reset_timeout_ms: 60000
  dlq_routing:
    enabled: true
    topic_suffix: ".dlq"
    include_error_context: true
# Dependencies
# ============
# NOTE: External library dependencies (confluent_kafka) are valid.
# Internal module dependencies are commented out until migrated from _legacy.
#
# TODO(#19): Migrate these modules from _legacy to canonical structure
# Issue: https://github.com/OmniNode-ai/omniintelligence/issues/19
# - omniintelligence.clients.client_intelligence_service (currently in _legacy/clients/)
# - omniintelligence.events.publisher.event_publisher (currently in _legacy/events/publisher/)
#
dependencies:
  # - name: "intelligence_client"
  #   type: "protocol"
  #   module: "omniintelligence.clients.client_intelligence_service"
  #   description: "Client for Archon intelligence service"
  - name: "kafka_consumer"
    type: "protocol"
    module: "confluent_kafka"
    description: "Kafka consumer for event subscription"
    # - name: "event_publisher"
    #   type: "protocol"
    #   module: "omniintelligence.events.publisher.event_publisher"
    #   description: "Event publisher for result events"
# Health Check
# ============
health_check:
  enabled: true
  endpoint: "/health"
  interval_seconds: 30
# Metadata
# ========
metadata:
  author: "OmniNode Team"
  created: "2025-10-21"
  updated: "2026-01-24"
  notes: |
    - 2026-01-24: OMN-1437 Refactor - Extracted models to omniintelligence.models.events,
      enabled handler_routing section, updated payload_module references.
    - 2026-01-18: Clarified handler routing status - section was intentionally commented
      out because handler modules did not exist.
    - 2026-01-18: Fixed payload_module references to point to actual node implementation
      where inline stub models were defined.
  tags:
    - "ONEX"
    - "effect"
    - "intelligence"
    - "adapter"
    - "kafka"
    - "events"
