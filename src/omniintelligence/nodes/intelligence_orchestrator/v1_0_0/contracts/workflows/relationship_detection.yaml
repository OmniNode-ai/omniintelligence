name: relationship_detection_workflow
version:
  major: 1
  minor: 0
  patch: 0

description: |
  Llama Index workflow for detecting relationships between entities.
  Analyzes entity connections and stores them in the knowledge graph.

workflow_type: sequential

steps:
  - name: validate_input
    type: validation
    description: Validate entities input
    handler: validate_relationship_input
    on_error: fail_immediately

  - name: detect_relationships
    type: compute
    description: Detect relationships between entities
    compute_node: relationship_detection_compute
    input:
      entities: ${input.entities}
      context: ${input.context}
    output: relationships_result

  - name: classify_relationships
    type: compute
    description: Classify relationship types and strengths
    compute_node: relationship_detection_compute
    input:
      relationships: ${relationships_result.relationships}
      entities: ${input.entities}
    output: classified_relationships
    depends_on:
      - detect_relationships

  - name: store_in_graph
    type: effect
    description: Store relationships in Memgraph knowledge graph
    effect_node: memgraph_graph_effect
    input:
      relationships: ${classified_relationships.relationships}
      entities: ${input.entities}
      correlation_id: ${input.correlation_id}
    depends_on:
      - classify_relationships

  - name: update_entity_metadata
    type: effect
    description: Update entity metadata with relationship counts
    effect_node: memgraph_graph_effect
    input:
      operation: update_metadata
      entity_ids: ${input.entities.map(e => e.id)}
      metadata_updates:
        relationship_count: ${classified_relationships.relationships.length}
        last_updated: ${now()}
    depends_on:
      - store_in_graph

# Error handling
error_handling:
  on_step_failure:
    - name: log_error
      type: logging
      handler: log_relationship_error
      input:
        entities: ${input.entities}
        error: ${error}

  retry_policy:
    max_retries: 3
    retry_on_steps:
      - store_in_graph
      - update_entity_metadata
    backoff_strategy: exponential

# Performance settings
performance:
  timeout_seconds: 300
  enable_caching: false  # Relationships change frequently

# Monitoring
monitoring:
  track_step_duration: true
  track_relationship_types: true
  emit_progress_events: false
  log_level: INFO
