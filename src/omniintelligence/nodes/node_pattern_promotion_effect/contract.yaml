---
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodePatternPromotionEffect
#
# This contract defines the interface for the pattern promotion effect node.
# The node checks provisional patterns against promotion gates and promotes
# eligible patterns to validated status, emitting lifecycle events.
#
# Reference: OMN-1680 - Auto-promote logic for provisional patterns
# Reference: OMN-1757 - Refactor to declarative pattern

# Contract identifiers
name: "node_pattern_promotion_effect"
contract_name: "pattern_promotion_effect"
node_name: "pattern_promotion_effect"
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version:
  major: 1
  minor: 0
  patch: 0

# Node type
node_type: "EFFECT_GENERIC"

# Status
status: "active"

# Description
description: >
  Effect node for promoting provisional patterns to validated status based on rolling window success metrics.
  Evaluates patterns against configurable promotion gates (injection count, success rate, failure streak,
  disabled status) and emits lifecycle events for eligible patterns. Supports dry_run mode for previewing
  promotions without committing changes. Kafka is required infrastructure; lifecycle events are always
  emitted asynchronously. #magic___^_^___line
# Strongly typed I/O models
input_model:
  name: "ModelPromotionCheckRequest"
  module: "omniintelligence.nodes.node_pattern_promotion_effect.models"
  description: "Request model for promotion check operations with dry_run flag and thresholds."

# Output model - primary output for check_and_promote operation
output_model:
  name: "ModelPromotionCheckResult"
  module: "omniintelligence.nodes.node_pattern_promotion_effect.models"
  description: "Result model containing promotion outcomes, counts, and gate snapshots."

output_models:
  - name: "ModelPromotionCheckResult"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.models"
    operation: "check_and_promote"
    topic: "onex.evt.omniintelligence.pattern-promoted.v1"
    description: "Aggregated result of promotion check operation."
  - name: "ModelPromotionResult"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.models"
    operation: "promote_pattern"
    topic: "onex.cmd.omniintelligence.pattern-lifecycle-transition.v1"
    description: "Individual pattern promotion result with gate snapshot."

# =============================================================================
# HANDLER ROUTING (Operation-Based Dispatch)
# =============================================================================
# Routes operations based on the promotion action type. Implements two main
# operations: check_and_promote (batch) and promote_pattern (single).
#
# Execution Flow:
#   1. Receive promotion check request
#   2. Fetch provisional patterns from database
#   3. Evaluate each pattern against promotion gates
#   4. For eligible patterns: emit lifecycle event to Kafka (required infrastructure)
#   5. Return aggregated result with counts and snapshots
# =============================================================================
handler_routing:
  routing_strategy: "operation_match"
  entry_point:
    function: "check_and_promote_patterns"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
    type: "async"
    description: "Main entry point that checks and promotes eligible provisional patterns"
  handlers:
    # Check and promote - batch operation for all provisional patterns
    - operation: "check_and_promote"
      handler:
        function: "check_and_promote_patterns"
        module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
        type: "async"
      description: "Check all provisional patterns and promote eligible ones"
      actions:
        - "fetch provisional patterns from database"
        - "evaluate promotion gates (injection count, success rate, failure streak)"
        - "emit lifecycle events to Kafka for eligible patterns"
        - "return aggregated promotion results"

    # Promote single pattern - used internally by check_and_promote
    - operation: "promote_pattern"
      handler:
        function: "promote_pattern"
        module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
        type: "async"
      description: "Promote a single pattern from provisional to validated status"
      actions:
        - "build gate snapshot from pattern data"
        - "emit lifecycle event to Kafka"

    # Pure criteria check - no I/O
    - operation: "check_criteria"
      handler:
        function: "meets_promotion_criteria"
        module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
        type: "sync"
      description: "Pure function to check if a pattern meets promotion criteria"
      actions:
        - "evaluate injection count gate"
        - "evaluate success rate gate"
        - "evaluate failure streak gate"
        - "return boolean eligibility"

  # Default handler for unrecognized operations
  default_handler:
    function: "check_and_promote_patterns"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
    type: "async"
    description: "Default to check_and_promote for promotion requests"

# =============================================================================
# IO OPERATIONS
# =============================================================================
io_operations:
  - operation: "check_and_promote"
    description: "Check all provisional patterns and promote eligible ones"
    input_model: "ModelPromotionCheckRequest"
    output_model: "ModelPromotionCheckResult"
    output_topic: "onex.evt.omniintelligence.pattern-promoted.v1"
    input_fields:
      - dry_run
      - correlation_id
      - min_injection_count
      - min_success_rate
      - max_failure_streak
    output_fields:
      - dry_run
      - patterns_checked
      - patterns_eligible
      - patterns_promoted
      - correlation_id

  - operation: "promote_pattern"
    description: "Promote a single pattern via lifecycle event"
    input_model: "ModelPromotionCheckRequest"
    output_model: "ModelPromotionResult"
    output_topic: "onex.cmd.omniintelligence.pattern-lifecycle-transition.v1"
    input_fields:
      - pattern_id
      - pattern_data
      - correlation_id
    output_fields:
      - pattern_id
      - pattern_signature
      - from_status
      - to_status
      - promoted_at
      - reason
      - gate_snapshot
      - dry_run

# =============================================================================
# PUBLISHED EVENTS (Kafka) - Documentation Layer
# =============================================================================
# PURPOSE: Human-readable documentation of WHAT events this node produces.
#
# This section provides rich metadata for:
#   - IntentTypeExtractor (capability inference)
#   - Contract validation and diff computation
#   - Human understanding of node behavior
#
# Topic naming: onex.{kind}.{producer}.{event-name}.v{n}
#   - kind=cmd for commands/inputs
#   - kind=evt for events/outputs
# =============================================================================
published_events:
  - topic_suffix: "onex.cmd.omniintelligence.pattern-lifecycle-transition.v1"
    full_topic_pattern: "{env}.onex.cmd.omniintelligence.pattern-lifecycle-transition.v1"
    event_type: "PatternLifecycleEvent"
    trigger: "Pattern meets promotion gates (injection count, success rate, failure streak)"
    description: "Emitted when a provisional pattern is eligible for promotion. Contains pattern ID, gate
      snapshot, and promotion reason. Consumed by reducer for FSM validation."

# =============================================================================
# EVENT BUS SUBCONTRACT - Runtime Routing Layer
# =============================================================================
# PURPOSE: Machine-readable configuration of WHERE events are routed.
#
# This subcontract provides structured topic routing for:
#   - RuntimeHostProcess auto-discovery and wiring
#   - Kafka topic subscription/publication
#   - Schema validation via topic metadata
#
# NOTE: Kafka is REQUIRED infrastructure. Effect nodes emit events asynchronously and must
# never block the calling thread waiting for Kafka acks.
# =============================================================================
event_bus:
  version:
    major: 1
    minor: 0
    patch: 0
  event_bus_enabled: true

  # Topics this node subscribes to (receives events from)
  # This node is typically triggered by scheduled jobs, not Kafka events
  subscribe_topics: []

  # Topics this node publishes to (sends events to)
  publish_topics:
    - "onex.cmd.omniintelligence.pattern-lifecycle-transition.v1"

  # Metadata for published topics
  publish_topic_metadata:
    "onex.cmd.omniintelligence.pattern-lifecycle-transition.v1":
      schema_ref: "omniintelligence.models.events.ModelPatternLifecycleEvent"
      description: "Lifecycle event for pattern status transitions (promote, demote)"
      content_type: "application/json"

# =============================================================================
# DEPENDENCIES
# =============================================================================
dependencies:
  - name: "pattern_repository"
    type: "protocol"
    class_name: "ProtocolPatternRepository"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
    description: "Pattern repository protocol for database operations (fetch, execute)"
    required: true

  - name: "kafka_producer"
    type: "protocol"
    class_name: "ProtocolKafkaPublisher"
    module: "omniintelligence.nodes.node_pattern_promotion_effect.handlers.handler_promotion"
    description: "Kafka producer for emitting pattern lifecycle events. Required infrastructure per ONEX
      invariant."
    required: true

# =============================================================================
# PROMOTION GATES CONFIGURATION
# =============================================================================
# Default thresholds for promotion gates. These can be overridden via handler parameters.
# See handler_promotion.py for detailed gate documentation.
promotion_gates:
  min_injection_count: 5
  min_success_rate: 0.6
  max_failure_streak: 3
  gate_descriptions:
    injection_count: "Pattern must have >= min_injection_count injections in rolling window"
    success_rate: "Pattern must have >= min_success_rate (success_count / total_outcomes)"
    failure_streak: "Pattern must have < max_failure_streak consecutive failures"
    disabled: "Pattern must not be in disabled_patterns_current table"

# =============================================================================
# ERROR HANDLING
# =============================================================================
error_handling:
  retry_policy:
    max_retries: 3
    initial_delay_ms: 100
    max_delay_ms: 5000
    exponential_base: 2
    retry_on:
      - "ConnectionError"
      - "TimeoutError"
      - "DatabaseUnavailableError"

  error_types:
    - name: "PromotionInputValidationError"
      error_code: "PROMO_001"
      description: "Input validation failed (e.g., invalid request parameters)"
      recoverable: false
      retry_strategy: "none"
    - name: "PromotionDatabaseError"
      error_code: "PROMO_002"
      description: "Error during database operation (pattern fetch or status update)"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "PromotionKafkaError"
      error_code: "PROMO_003"
      description: "Error publishing lifecycle event to Kafka"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "PromotionCriteriaError"
      error_code: "PROMO_004"
      description: "Error evaluating promotion criteria against rolling window metrics"
      recoverable: false
      retry_strategy: "none"

# =============================================================================
# CAPABILITIES
# =============================================================================
capabilities:
  - name: "pattern_promotion.check_and_promote"
    description: "Check all provisional patterns and promote eligible ones"
    version: "1.0.0"
  - name: "pattern_promotion.promote_single"
    description: "Promote a single pattern with gate snapshot"
    version: "1.0.0"
  - name: "pattern_promotion.criteria_check"
    description: "Pure function to check promotion eligibility"
    version: "1.0.0"
  - name: "pattern_promotion.kafka_emission"
    description: "Emit lifecycle events to Kafka for downstream processing"
    version: "1.0.0"

# =============================================================================
# IDEMPOTENCY
# =============================================================================
idempotency:
  enabled: true
  strategy: "event_id_tracking"
  hash_fields: ["pattern_id", "from_status", "to_status"]
  description: "Each lifecycle event has a unique request_id. Re-processing the same promotion request
    is idempotent - already-validated patterns are skipped."

# =============================================================================
# HEALTH CHECK
# =============================================================================
health_check:
  enabled: true
  endpoint: "/health"
  interval_seconds: 30

# =============================================================================
# METADATA
# =============================================================================
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-30"
  updated: "2026-02-05"
  tags:
    - effect
    - pattern-promotion
    - rolling-window
    - kafka
    - database
    - state-transition
    - provisional-to-validated
  references:
    - ticket: "OMN-1680"
      url: "https://linear.app/omninode/issue/OMN-1680"
      description: "Auto-promote logic for provisional patterns"
    - ticket: "OMN-1757"
      url: "https://linear.app/omninode/issue/OMN-1757"
      description: "Refactor to declarative pattern"
    - ticket: "OMN-1805"
      url: "https://linear.app/omninode/issue/OMN-1805"
      description: "Event-driven lifecycle transitions"
