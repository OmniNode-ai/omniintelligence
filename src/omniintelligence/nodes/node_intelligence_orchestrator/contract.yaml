---
# ONEX Node Contract - Intelligence Orchestrator Node
#
# This orchestrator coordinates intelligence workflows using Llama Index.
# Routes operations via EnumIntelligenceOperationType to appropriate workflows:
#   - DOCUMENT_INGESTION: Vectorize, extract entities, delegate storage to omnimemory
#   - PATTERN_LEARNING: 4-phase (Foundation -> Matching -> Validation -> Traceability)
#   - QUALITY_ASSESSMENT: Score code quality, check ONEX compliance
#   - SEMANTIC_ANALYSIS: Generate embeddings, compute similarity
#   - RELATIONSHIP_DETECTION: Detect and classify relationships, delegate storage to omnimemory
# =============================================================================
contract_version:
  major: 1
  minor: 1
  patch: 0
node_version:
  major: 1
  minor: 1
  patch: 0
name: "node_intelligence_orchestrator"
node_type: "ORCHESTRATOR_GENERIC"
description: >-
  Unified orchestrator for all intelligence operations using Llama Index workflows. Handles document ingestion,
  pattern learning, quality assessment, semantic analysis, and relationship detection workflows.
input_model:
  name: "ModelOrchestratorInput"
  module: "omniintelligence.nodes.node_intelligence_orchestrator.models"
  description: "Input containing operation type, entity ID, payload, and correlation ID."
output_model:
  name: "ModelOrchestratorOutput"
  module: "omniintelligence.nodes.node_intelligence_orchestrator.models"
  description: "Output containing workflow execution results, intents, and any errors."
# Workflow Coordination Configuration
# ====================================
# Defines the Llama Index workflow execution graph for intelligence operations.
# Each workflow is triggered by the operation_type field in the input model.
workflow_coordination:
  workflow_definition:
    workflow_metadata:
      workflow_name: "intelligence_workflow"
      workflow_version:
        major: 1
        minor: 0
        patch: 0
      description: "Routes intelligence operations to appropriate compute/effect nodes"
    execution_graph:
      nodes:
        - node_id: "receive_request"
          node_type: EFFECT_GENERIC
          description: "Receive intelligence operation request"
          step_config:
            event_pattern: ["intelligence.*"]
        # Note: route_operation is an internal orchestration step, not a compute delegator.
        # It routes based on operation_type to determine which compute/effect nodes to invoke.
        - node_id: "route_operation"
          node_type: ORCHESTRATOR_INTERNAL
          description: "Route operation based on EnumIntelligenceOperationType"
          depends_on: ["receive_request"]
          step_config:
            routing_field: "operation_type"
            routing_strategy: "operation_type_match"
        # Note: execute_compute is a dynamic dispatcher that invokes the appropriate
        # compute node based on the routing decision from route_operation.
        - node_id: "execute_compute"
          node_type: ORCHESTRATOR_INTERNAL
          description: "Dispatch to appropriate compute node based on operation routing"
          depends_on: ["route_operation"]
          step_config:
            dispatch_strategy: "dynamic_compute_selection"
            available_compute_nodes:
              - pattern_extraction_compute
              - pattern_learning_compute
              - pattern_matching_compute
              - quality_scoring_compute
              - semantic_analysis_compute
        - node_id: "execute_effects"
          node_type: EFFECT_GENERIC
          description: "Execute effect nodes for persistence"
          depends_on: ["execute_compute"]
          step_config:
            # Effect nodes are handled via intelligence_adapter_effect
            effect_nodes: []
        - node_id: "publish_outcome"
          node_type: EFFECT_GENERIC
          description: "Publish workflow outcome event"
          depends_on: ["execute_effects"]
          step_config:
            event_type: "IntelligenceOperationResult"
    coordination_rules:
      execution_mode: parallel
      parallel_execution_allowed: true
      max_parallel_branches: 5
      failure_recovery_strategy: retry
      max_retries: 3
      recovery_enabled: true
      timeout_ms: 300000
      checkpoint_enabled: true
      checkpoint_interval_ms: 10000
      state_persistence_enabled: true
      rollback_enabled: true
# Handler Routing Configuration (OMN-2034)
# ==========================================
# Defines handler routing for intent reception from the intelligence reducer.
# The orchestrator receives ModelIntent events and logs them for observability.
handler_routing:
  routing_strategy: "intent_type_match"
  handlers:
    - operation: "receive_intent"
      handler:
        function: "handle_receive_intent"
        module: "omniintelligence.nodes.node_intelligence_orchestrator.handlers.handler_receive_intent"
        type: "sync"
      description: "Receive and log a single intent from the reducer"
    - operation: "receive_intents"
      handler:
        function: "handle_receive_intents"
        module: "omniintelligence.nodes.node_intelligence_orchestrator.handlers.handler_receive_intent"
        type: "sync"
      description: "Receive and log a batch of intents from reducer output"
# Intent Reception Configuration (OMN-2034)
# ==========================================
# Declares the orchestrator as a consumer of reducer intents.
# This proves the intent channel works end-to-end with a minimal contract.
intent_reception:
  enabled: true
  source: "node_intelligence_reducer"
  intent_types:
    - "extension"
  receipt_model:
    name: "ModelIntentReceipt"
    module: "omniintelligence.nodes.node_intelligence_orchestrator.models"
  description: "Receives intents emitted by the intelligence reducer for logging and observability"
# Consumed Events
# ===============
consumed_events:
  - topic: "{env}.onex.cmd.omniintelligence.code-analysis.v1"
    event_type: "CodeAnalysisRequested"
  - topic: "{env}.onex.cmd.omniintelligence.document-ingestion.v1"
    event_type: "DocumentIngestionRequested"
  - topic: "{env}.onex.cmd.omniintelligence.pattern-learning.v1"
    event_type: "PatternLearningRequested"
  - topic: "{env}.onex.cmd.omniintelligence.quality-assessment.v1"
    event_type: "QualityAssessmentRequested"
# Published Events
# ================
published_events:
  - topic: "{env}.onex.evt.omniintelligence.code-analysis-completed.v1"
    event_type: "CodeAnalysisCompleted"
  - topic: "{env}.onex.evt.omniintelligence.code-analysis-failed.v1"
    event_type: "CodeAnalysisFailed"
  - topic: "{env}.onex.evt.omniintelligence.document-ingestion-completed.v1"
    event_type: "DocumentIngestionCompleted"
  - topic: "{env}.onex.evt.omniintelligence.pattern-learning-completed.v1"
    event_type: "PatternLearningCompleted"
  - topic: "{env}.onex.evt.omniintelligence.quality-assessment-completed.v1"
    event_type: "QualityAssessmentCompleted"
# Dependencies
# ============
dependencies:
  - name: "pattern_extraction_compute"
    type: "node"
    module: "omniintelligence.nodes.node_pattern_extraction_compute"
    description: "Compute node for pattern extraction from execution traces."
  - name: "pattern_learning_compute"
    type: "node"
    module: "omniintelligence.nodes.node_pattern_learning_compute"
    description: "Compute node for ML-based pattern learning pipeline."
  - name: "pattern_matching_compute"
    type: "node"
    module: "omniintelligence.nodes.node_pattern_matching_compute"
    description: "Compute node for pattern matching."
  - name: "quality_scoring_compute"
    type: "node"
    module: "omniintelligence.nodes.node_quality_scoring_compute"
    description: "Compute node for quality scoring."
  - name: "semantic_analysis_compute"
    type: "node"
    module: "omniintelligence.nodes.node_semantic_analysis_compute"
    description: "Compute node for semantic analysis."
  - name: "intelligence_reducer"
    type: "node"
    module: "omniintelligence.nodes.node_intelligence_reducer"
    description: "Reducer for FSM state management."
  - name: "intelligence_adapter_effect"
    type: "node"
    module: "omniintelligence.nodes.intelligence_adapter"
    description: "Effect node for intelligence API operations via adapter pattern."
# =============================================================================
# EVENT BUS SUBCONTRACT - Runtime Routing Layer
# =============================================================================
# PURPOSE: Machine-readable configuration of WHERE events are routed.
#
# This subcontract provides structured topic routing for:
#   - RuntimeHostProcess auto-discovery and wiring
#   - Kafka topic subscription/publication
#   - Schema validation via topic metadata
#
# The orchestrator subscribes to command topics for intelligence operations
# and publishes completion/failure events for downstream consumers.
# =============================================================================
event_bus:
  version:
    major: 1
    minor: 0
    patch: 0
  event_bus_enabled: true

  subscribe_topics:
    - "{env}.onex.cmd.omniintelligence.code-analysis.v1"
    - "{env}.onex.cmd.omniintelligence.document-ingestion.v1"
    - "{env}.onex.cmd.omniintelligence.pattern-learning.v1"
    - "{env}.onex.cmd.omniintelligence.quality-assessment.v1"

  publish_topics:
    - "{env}.onex.evt.omniintelligence.code-analysis-completed.v1"
    - "{env}.onex.evt.omniintelligence.code-analysis-failed.v1"
    - "{env}.onex.evt.omniintelligence.document-ingestion-completed.v1"
    - "{env}.onex.evt.omniintelligence.pattern-learning-completed.v1"
    - "{env}.onex.evt.omniintelligence.quality-assessment-completed.v1"

  subscribe_topic_metadata:
    "{env}.onex.cmd.omniintelligence.code-analysis.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorInput"
      description: "Code analysis operation requests"
    "{env}.onex.cmd.omniintelligence.document-ingestion.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorInput"
      description: "Document ingestion operation requests"
    "{env}.onex.cmd.omniintelligence.pattern-learning.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorInput"
      description: "Pattern learning operation requests"
    "{env}.onex.cmd.omniintelligence.quality-assessment.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorInput"
      description: "Quality assessment operation requests"

  publish_topic_metadata:
    "{env}.onex.evt.omniintelligence.code-analysis-completed.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorOutput"
      description: "Code analysis workflow completed successfully"
      content_type: "application/json"
    "{env}.onex.evt.omniintelligence.code-analysis-failed.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorOutput"
      description: "Code analysis workflow failed with error details"
      content_type: "application/json"
    "{env}.onex.evt.omniintelligence.document-ingestion-completed.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorOutput"
      description: "Document ingestion workflow completed successfully"
      content_type: "application/json"
    "{env}.onex.evt.omniintelligence.pattern-learning-completed.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorOutput"
      description: "Pattern learning workflow completed successfully"
      content_type: "application/json"
    "{env}.onex.evt.omniintelligence.quality-assessment-completed.v1":
      schema_ref: "omniintelligence.nodes.node_intelligence_orchestrator.models.ModelOrchestratorOutput"
      description: "Quality assessment workflow completed successfully"
      content_type: "application/json"

# =============================================================================
# IDEMPOTENCY
# =============================================================================
idempotency:
  enabled: true
  strategy: "correlation_id_tracking"
  key_field: "correlation_id"
  description: >
    Uses correlation_id from the input model as the idempotency key. Before executing a workflow, checks
    if the correlation_id was already processed. If a duplicate is detected, returns the cached result
    without re-executing. Records correlation_id after successful workflow completion to prevent duplicate
    processing of the same intelligence operation request.

# Error Handling Configuration
# ============================
error_handling:
  retry_policy:
    max_retries: 3
    initial_delay_ms: 2000
    max_delay_ms: 30000
    exponential_base: 2
    retry_on:
      - "ComputeExecutionError"
      - "EffectExecutionError"
      - "ConnectionError"
      - "TimeoutError"
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    reset_timeout_ms: 60000
  error_types:
    - name: "ComputeExecutionError"
      error_code: "ORCH_001"
      description: "Error during compute node execution"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "EffectExecutionError"
      error_code: "ORCH_002"
      description: "Error during effect node execution"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "WorkflowTimeoutError"
      error_code: "ORCH_003"
      description: "Workflow execution exceeded timeout"
      recoverable: false
      retry_strategy: "none"
# Health Check
# ============
health_check:
  enabled: true
  endpoint: "/health"
  interval_seconds: 30
# Metadata
# ========
metadata:
  author: "OmniNode Team"
  created: "2025-11-14"
  updated: "2026-02-13"
  tags:
    - "ONEX"
    - "orchestrator"
    - "intelligence"
    - "workflows"
    - "llama-index"
