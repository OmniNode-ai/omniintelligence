# FSM Subcontract: Quality Assessment
# Defines state machine for quality scoring workflow
# RAW -> ASSESSING -> SCORED -> STORED (or FAILED with retry)

version:
  major: 1
  minor: 0
  patch: 0

state_machine_name: quality_assessment_fsm
state_machine_version:
  major: 1
  minor: 0
  patch: 0

description: |
  Quality assessment finite state machine.
  Tracks code/document quality scoring from raw input through storage.
  Supports retry from FAILED and reassessment from STORED.

# State Definitions
states:
  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: RAW
    state_type: operational
    description: Raw input received, awaiting quality assessment
    is_terminal: false
    is_recoverable: true
    entry_actions: []
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - code_content

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: ASSESSING
    state_type: operational
    description: Quality assessment in progress
    is_terminal: false
    is_recoverable: true
    timeout_ms: 180000  # 3 minutes
    entry_actions:
      - start_assessment
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - code_content

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: SCORED
    state_type: operational
    description: Quality score computed, awaiting storage
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - prepare_storage
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - quality_score

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: STORED
    state_type: snapshot
    description: Quality results stored in database
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - notify_completion
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - quality_score
      - storage_reference

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: FAILED
    state_type: error
    description: Quality assessment failed
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - notify_failure
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - error_message

# Initial and Special States
initial_state: RAW
terminal_states: []  # Can always reassess
error_states:
  - FAILED

# Transition Definitions
transitions:
  # RAW transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: start_assessment
    from_state: RAW
    to_state: ASSESSING
    trigger: START_ASSESSMENT
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: QUALITY_ASSESSMENT

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_raw
    from_state: RAW
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: RAW

  # ASSESSING transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: complete_scoring
    from_state: ASSESSING
    to_state: SCORED
    trigger: COMPLETE_SCORING
    priority: 1
    conditions: []
    actions:
      - action_name: emit_scoring_complete
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: SCORING_COMPLETE

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_assessing
    from_state: ASSESSING
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: ASSESSING

  # SCORED transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: store_results
    from_state: SCORED
    to_state: STORED
    trigger: STORE_RESULTS
    priority: 1
    conditions: []
    actions:
      - action_name: emit_completion_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_STORED

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_scored
    from_state: SCORED
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: SCORED

  # STORED transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: reassess
    from_state: STORED
    to_state: ASSESSING
    trigger: REASSESS
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: QUALITY_ASSESSMENT

  # FAILED transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: retry_from_failed
    from_state: FAILED
    to_state: ASSESSING
    trigger: RETRY
    priority: 1
    retry_enabled: true
    max_retries: 3
    retry_delay_ms: 5000
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: QUALITY_ASSESSMENT

# Persistence Configuration
persistence_enabled: true
checkpoint_interval_ms: 30000
max_checkpoints: 10
recovery_enabled: true
rollback_enabled: true

# Validation and Monitoring
strict_validation_enabled: true
state_monitoring_enabled: true
event_logging_enabled: true
conflict_resolution_strategy: priority_based
concurrent_transitions_allowed: false
transition_timeout_ms: 5000
