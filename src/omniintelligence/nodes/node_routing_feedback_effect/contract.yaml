# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeRoutingFeedbackEffect
#
# This contract defines the interface for the routing feedback effect node.
# The node consumes routing-outcome-raw events from omniclaude's session-end hook
# and persists idempotent upsert records to routing_feedback_scores table.
#
# Reference:
#   - OMN-2366: Add routing.feedback consumer in omniintelligence (orphan topic)
#   - OMN-2356: Session-end hook routing feedback producer (omniclaude)
#   - OMN-2935: Fix routing feedback loop — subscribe to routing-outcome-raw.v1

# =============================================================================
# IDENTIFIERS
# =============================================================================
name: "node_routing_feedback_effect"
contract_name: "node_routing_feedback_effect"
node_name: "node_routing_feedback_effect"
contract_version:
  major: 1
  minor: 1
  patch: 0
node_version:
  major: 1
  minor: 1
  patch: 0

# Node type
node_type: "EFFECT_GENERIC"

# Description
description: >
  Effect node for processing routing-feedback events from omniclaude. Consumes onex.evt.omniclaude.routing-feedback.v1
  events, filters on feedback_status ("produced" = persist to DB, "skipped" = log only). Upserts idempotent
  records to routing_feedback_scores table using session_id as the idempotency key. Publishes onex.evt.omniintelligence.routing-feedback-processed.v1
  after successful upsert. OMN-2622: Switched from routing-outcome-raw.v1 (deprecated); routing-feedback-skipped.v1
  folded into routing-feedback.v1 via feedback_status field.
# =============================================================================
# I/O MODELS
# =============================================================================
input_model:
  name: "ModelRoutingFeedbackPayload"
  module: "omniintelligence.nodes.node_routing_feedback_effect.models"
  description: "Routing-feedback event from omniclaude (OMN-2622: replaces routing-outcome-raw)"

output_model:
  name: "ModelRoutingFeedbackResult"
  module: "omniintelligence.nodes.node_routing_feedback_effect.models"
  description: "Result of routing feedback processing with upsert status"

# =============================================================================
# HANDLER ROUTING
# =============================================================================
handler_routing:
  routing_strategy: "operation_match"
  handlers:
    - operation: "process_routing_feedback"
      handler:
        function: "process_routing_feedback"
        module: "omniintelligence.nodes.node_routing_feedback_effect.handlers.handler_routing_feedback"
        type: "async"
      description: "Consume routing-feedback event, filter on feedback_status, upsert produced events
        to routing_feedback_scores, publish processed event"
      output_fields:
        - status
        - session_id
        - outcome
        - feedback_status
        - skip_reason
        - was_upserted
        - processed_at
        - error_message

# =============================================================================
# IO OPERATIONS
# =============================================================================
io_operations:
  - operation: "process_routing_feedback"
    description: "Process routing-feedback event: filter on feedback_status, upsert produced events, skip
      skipped events"
    input_fields:
      - session_id
      - outcome
      - feedback_status
      - skip_reason
      - correlation_id
      - emitted_at
    output_fields:
      - status
      - session_id
      - outcome
      - feedback_status
      - skip_reason
      - was_upserted
      - processed_at
      - error_message

# =============================================================================
# DEPENDENCIES
# =============================================================================
dependencies:
  - name: "repository"
    type: "protocol"
    class_name: "ProtocolPatternRepository"
    module: "omniintelligence.protocols"
    description: "Repository protocol for upsert operations on routing_feedback_scores"
    required: true
  - name: "kafka_publisher"
    type: "protocol"
    class_name: "ProtocolKafkaPublisher"
    module: "omniintelligence.protocols"
    description: "Optional Kafka publisher for routing-feedback-processed events. Absent = graceful degradation"
    required: false

# =============================================================================
# ERROR HANDLING
# =============================================================================
error_handling:
  retry_policy:
    max_retries: 3
    initial_delay_ms: 100
    max_delay_ms: 2000
    exponential_base: 2
    retry_on:
      - "ConnectionError"
      - "TimeoutError"

  error_types:
    - name: "DatabaseWriteError"
      description: "Failed to upsert routing feedback record to PostgreSQL"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "ValidationError"
      description: "Invalid routing feedback event data"
      recoverable: false
      retry_strategy: "none"

# =============================================================================
# EVENT BUS
# =============================================================================
event_bus:
  version:
    major: 1
    minor: 0
    patch: 0
  event_bus_enabled: true

  subscribe_topics:
    # NOTE: This topic uses 'evt' kind (not 'cmd') because it is produced by omniclaude.
    # The topic name is dictated by the producer; this is an intentional cross-system
    # exception to the convention that subscribe topics use 'cmd' kind.
    # OMN-2622: Switched back from routing-outcome-raw.v1 (deprecated) to routing-feedback.v1.
    # routing-feedback.v1 now carries both produced and skipped outcomes via feedback_status field.
    - "onex.evt.omniclaude.routing-feedback.v1"

  publish_topics:
    - "onex.evt.omniintelligence.routing-feedback-processed.v1"

  subscribe_topic_metadata:
    "onex.evt.omniclaude.routing-feedback.v1":
      schema_ref: "omniintelligence.nodes.node_routing_feedback_effect.models.ModelRoutingFeedbackPayload"
      description: "Routing-feedback events from omniclaude (OMN-2622: includes feedback_status field)"

  publish_topic_metadata:
    "onex.evt.omniintelligence.routing-feedback-processed.v1":
      schema_ref: "omniintelligence.nodes.node_routing_feedback_effect.models.ModelRoutingFeedbackProcessedEvent"
      description: "Routing feedback processed confirmation events"

# =============================================================================
# IDEMPOTENCY
# =============================================================================
idempotency:
  enabled: true
  strategy: "event_id_tracking"
  hash_fields: ["session_id"]
  description: >
    Each routing-feedback event is uniquely identified by session_id. Re-processing the same event is
    idempotent via ON CONFLICT (session_id) DO UPDATE SET outcome and processed_at. Skipped events (feedback_status
    == "skipped") do not touch the DB at all. This handles at-least-once Kafka delivery without creating
    duplicate rows. OMN-2622: Switched from routing-outcome-raw.v1 to routing-feedback.v1.

# =============================================================================
# CAPABILITIES
# =============================================================================
capabilities:
  - name: "database_write"
    description: "Upsert routing feedback records to routing_feedback_scores in PostgreSQL"
  - name: "idempotent_upsert"
    description: "ON CONFLICT upsert prevents duplicate records from at-least-once Kafka delivery"
  - name: "event_publish"
    description: "Publish routing-feedback-processed events to Kafka (optional, graceful degradation)"

# =============================================================================
# METADATA
# =============================================================================
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2026-02-20"
  updated: "2026-02-28"
  tags:
    - effect
    - routing-feedback
    - feedback-status
    - idempotent
    - postgresql
    - kafka
  references:
    - ticket: "OMN-2366"
      url: "https://linear.app/omninode/issue/OMN-2366"
      description: "Add routing.feedback consumer in omniintelligence (orphan topic)"
    - ticket: "OMN-2356"
      url: "https://linear.app/omninode/issue/OMN-2356"
      description: "Session-end hook routing feedback producer (omniclaude)"
    - ticket: "OMN-2935"
      url: "https://linear.app/omninode/issue/OMN-2935"
      description: "Fix routing feedback loop — subscribe to routing-outcome-raw.v1"
