# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeClaudeHookEventEffect
#
# This contract defines the interface for the unified Claude Code hook event
# handler. The node receives all Claude Code hook events and routes them to
# appropriate compute nodes based on event_type.
#
# Reference: OMN-1456 - Unified Claude Code hook endpoint

# Contract identifiers
name: "node_claude_hook_event_effect"
contract_name: "node_claude_hook_event_effect"
node_name: "node_claude_hook_event_effect"
contract_version:
  major: 1
  minor: 1
  patch: 0
node_version:
  major: 1
  minor: 1
  patch: 0

# Node type
node_type: "EFFECT_GENERIC"

# Description
description: >
  Unified Effect node for handling all Claude Code hook events. Receives events from SessionStart, UserPromptSubmit,
  PreToolUse, PostToolUse, Stop, and other hook types, routing them to appropriate handlers. For UserPromptSubmit,
  routes to node_intent_classifier_compute for classification and emits classified intents to Kafka for
  downstream consumers (graph storage handled by omnimemory). For Stop events, emits a pattern learning
  command to onex.cmd.omniintelligence.pattern-learning.v1 to trigger pattern extraction from session
  data.
# Strongly typed I/O models
input_model:
  name: "ModelClaudeCodeHookEvent"
  module: "omniintelligence.nodes.node_claude_hook_event_effect.models"
  description: "Unified input model for all Claude Code hook events."
output_model:
  name: "ModelClaudeHookResult"
  module: "omniintelligence.nodes.node_claude_hook_event_effect.models"
  description: "Output model containing processing status and intent classification results."

# =============================================================================
# HANDLER ROUTING (Event Type Based Dispatch)
# =============================================================================
# Routes events to handlers based on event_type field. Currently implements
# UserPromptSubmit routing to intent classification. Other event types return
# success (no-op) and are ready for future handler implementations.
#
# Implementation Note:
#   Handlers are implemented as async/sync functions, not classes.
#   The main entry point is `route_hook_event()` which dispatches to:
#     - `handle_user_prompt_submit()` for UserPromptSubmit events
#     - `handle_no_op()` for all other event types
#
# Execution Flow:
#   1. Receive ModelClaudeCodeHookEvent with event_type
#   2. Route to handler function based on event_type
#   3. For UserPromptSubmit: classify intent, emit to Kafka
#   4. For other types: return success (no-op)
#   5. Return ModelClaudeHookResult with processing outcome
# =============================================================================
handler_routing:
  routing_strategy: "event_type_match"
  entry_point:
    function: "route_hook_event"
    module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
    type: "async"
    description: "Main entry point that routes events to appropriate handler functions"
  handlers:
    # UserPromptSubmit - Intent Classification
    - event_type: "UserPromptSubmit"
      handler:
        function: "handle_user_prompt_submit"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "async"
      description: "Classify user prompt intent"
      actions:
        - "call node_intent_classifier_compute"
        - "emit to Kafka"

    # SessionStart - No-op (future: session tracking)
    - event_type: "SessionStart"
      handler:
        function: "handle_no_op"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "sync"
      description: "Session start event (no-op, future: session tracking)"

    # SessionEnd - No-op (future: session summary)
    - event_type: "SessionEnd"
      handler:
        function: "handle_no_op"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "sync"
      description: "Session end event (no-op, future: session summary)"

    # PreToolUse - No-op (future: tool validation)
    - event_type: "PreToolUse"
      handler:
        function: "handle_no_op"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "sync"
      description: "Pre-tool-use event (no-op, future: tool validation)"

    # PostToolUse - No-op (future: result capture)
    - event_type: "PostToolUse"
      handler:
        function: "handle_no_op"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "sync"
      description: "Post-tool-use event (no-op, future: result capture)"

    # Stop - Trigger pattern extraction (OMN-2210)
    - event_type: "Stop"
      handler:
        function: "handle_stop"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "async"
      description: "Stop event triggers pattern learning command emission"
      actions:
        - "emit onex.cmd.omniintelligence.pattern-learning.v1 to Kafka"

    # Notification - No-op (future: async notification handling)
    - event_type: "Notification"
      handler:
        function: "handle_no_op"
        module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
        type: "sync"
      description: "Notification event (no-op, future: async handling)"

  # Default handler for unrecognized event types
  default_handler:
    function: "handle_no_op"
    module: "omniintelligence.nodes.node_claude_hook_event_effect.handlers.handler_claude_event"
    type: "sync"
    description: "Default no-op handler for unrecognized event types"

# =============================================================================
# IO OPERATIONS
# =============================================================================
io_operations:
  - operation: "process_hook_event"
    description: "Process a Claude Code hook event and route to appropriate handler"
    input_fields:
      - event_type
      - session_id
      - correlation_id
      - timestamp_utc
      - payload
    output_fields:
      - status
      - event_type
      - session_id
      - correlation_id
      - intent_result
      - processing_time_ms
      - processed_at
      - error_message
      - metadata

# =============================================================================
# PUBLISHED EVENTS (Kafka) - Documentation Layer
# =============================================================================
# PURPOSE: Human-readable documentation of WHAT events this node produces.
#
# This section provides rich metadata for:
#   - IntentTypeExtractor (capability inference)
#   - Contract validation and diff computation
#   - Human understanding of node behavior
#
# Contains: event_type, trigger conditions, descriptions, full topic patterns.
#
# NOTE: This is intentionally separate from event_bus (below) which handles
# WHERE events are routed. Both are needed for Effect nodes:
#   - published_events = documentation layer (WHAT)
#   - event_bus = runtime routing layer (WHERE)
#
# Topic naming: onex.{kind}.{producer}.{event-name}.v{n}
#   - kind=cmd for commands/inputs
#   - kind=evt for events/outputs
# =============================================================================
published_events:
  - topic_suffix: "onex.cmd.omniintelligence.pattern-learning.v1"
    full_topic_pattern: "onex.cmd.omniintelligence.pattern-learning.v1"
    event_type: "PatternLearningRequested"
    trigger: "Stop event processed (session completed)"
    description: "Emitted when a Claude Code session stops to trigger pattern extraction in the intelligence
      orchestrator. Published directly via kafka_producer (not event_bus)."
    payload_fields:
      - name: "event_type"
        type: "string"
        description: "Always 'PatternLearningRequested'"
      - name: "session_id"
        type: "string"
        description: "Session ID from the hook event"
      - name: "correlation_id"
        type: "string"
        description: "Correlation ID for distributed tracing"
      - name: "trigger"
        type: "string"
        description: "Always 'session_stop'"
      - name: "timestamp"
        type: "string"
        description: "ISO-8601 timestamp of when the command was emitted"

  - topic_suffix: "onex.evt.omniintelligence.intent-classified.v1"
    full_topic_pattern: "onex.evt.omniintelligence.intent-classified.v1"
    event_type: "IntentClassified"
    event_version: "1.1.0"
    trigger: "UserPromptSubmit processed successfully"
    description: "Emitted when a user prompt intent is successfully classified. Consumed by omnimemory
      for graph storage. Enriched with ModelSemVer provenance fields in v1.1.0 (OMN-1620)."
    payload_fields:
      # -----------------------------------------------------------------------
      # Original fields (v1.0.0) — unchanged for backward compatibility
      # -----------------------------------------------------------------------
      - name: "event_type"
        type: "string"
        description: "Always 'IntentClassified'"
      - name: "session_id"
        type: "string"
        description: "Session ID from the hook event"
      - name: "correlation_id"
        type: "string"
        description: "Correlation ID for distributed tracing"
      - name: "intent_category"
        type: "string"
        description: "Classified intent category (e.g., debugging, code_generation)"
      - name: "confidence"
        type: "float"
        description: "Classification confidence score (0.0-1.0)"
      - name: "keywords"
        type: "list[str]"
        description: "Keywords extracted from intent classification (added in OMN-1626)"
      - name: "timestamp"
        type: "string"
        description: "ISO-8601 timestamp of when the event was emitted"
      # -----------------------------------------------------------------------
      # New fields (v1.1.0 — OMN-1620: ModelSemVer provenance enrichment)
      # -----------------------------------------------------------------------
      - name: "event_version"
        type: "ModelSemVer"
        description: "Event schema version as ModelSemVer structured dict {major, minor, patch}. Downstream:
          ModelSemVer.model_validate(payload['event_version']). Current value: 1.1.0."
        added_in: "OMN-1620"
      - name: "secondary_intents"
        type: "list[dict]"
        description: "Secondary intent results from classifier. Each entry has intent_category, confidence,
          keywords. Empty list when no secondary intents or no classifier."
        added_in: "OMN-1620"
      - name: "success"
        type: "bool"
        description: "Whether intent classification succeeded. False when classifier returned an error
          result."
        added_in: "OMN-1620"
      - name: "provenance"
        type: "dict"
        description: "Structured provenance object for downstream tracing and debugging. Contains: source_system
          (str), source_node (str), classifier_version (ModelSemVer structured dict {major, minor, patch}),
          processing_time_ms (float)."
        added_in: "OMN-1620"

# =============================================================================
# EVENT BUS SUBCONTRACT - Runtime Routing Layer
# =============================================================================
# PURPOSE: Machine-readable configuration of WHERE events are routed.
#
# This subcontract provides structured topic routing for:
#   - RuntimeHostProcess auto-discovery and wiring
#   - Kafka topic subscription/publication
#   - Schema validation via topic metadata
#
# Contains: topic suffixes (simple strings) + optional schema references.
#
# NOTE: This is intentionally separate from published_events (above) which
# documents WHAT events this node produces. Both are needed for Effect nodes:
#   - published_events = documentation layer (WHAT)
#   - event_bus = runtime routing layer (WHERE)
#
# Added by OMN-1537 for topic-based routing configuration.
# =============================================================================
event_bus:
  version:
    major: 1
    minor: 0
    patch: 0
  event_bus_enabled: true

  # Topics this node subscribes to (receives events from)
  subscribe_topics:
    - "onex.cmd.omniintelligence.claude-hook-event.v1"
    - "onex.cmd.omniintelligence.tool-content.v1"

  # Topics this node publishes to (sends events to)
  publish_topics:
    - "onex.evt.omniintelligence.intent-classified.v1"
    - "onex.cmd.omniintelligence.pattern-learning.v1"

  # Metadata for subscribed topics
  # Note: consumer_group is NOT specified here - it's runtime configuration
  # via KAFKA_GROUP environment variable or ModelKafkaEventBusConfig.group
  subscribe_topic_metadata:
    "onex.cmd.omniintelligence.claude-hook-event.v1":
      schema_ref: "omniintelligence.nodes.node_claude_hook_event_effect.models.ModelClaudeCodeHookEvent"
      description: "Claude Code hook events from omniclaude (SessionStart, UserPromptSubmit, PreToolUse,
        PostToolUse, Stop, etc.)"
    "onex.cmd.omniintelligence.tool-content.v1":
      schema_ref: "omniintelligence.nodes.node_claude_hook_event_effect.models.ModelClaudeCodeHookEvent"
      description: "Tool content events from omniclaude containing PostToolUse payloads with file contents,
        command outputs, and other tool results for intelligence analysis."

  # Metadata for published topics
  publish_topic_metadata:
    "onex.evt.omniintelligence.intent-classified.v1":
      schema_ref: "omniintelligence.nodes.node_claude_hook_event_effect.models.ModelClaudeHookResult"
      description: "Classified intent results from UserPromptSubmit processing"
    "onex.cmd.omniintelligence.pattern-learning.v1":
      schema_ref: "omniintelligence.nodes.node_claude_hook_event_effect.models.ModelPatternLearningCommand"
      description: "Pattern learning command emitted on Stop event to trigger pattern extraction"

# =============================================================================
# DEPENDENCIES
# =============================================================================
dependencies:
  - name: "node_intent_classifier_compute"
    type: "node"
    node_name: "node_intent_classifier_compute"
    module: "omniintelligence.nodes.node_intent_classifier_compute"
    description: "Compute node for classifying user prompt intents"
    required: true

  - name: "kafka_producer"
    type: "protocol"
    class_name: "ProtocolKafkaProducer"
    module: "omnibase_infra.protocols.protocol_kafka_producer"
    description: "Kafka producer for emitting classified intent events"
    required: false

# =============================================================================
# ERROR HANDLING
# =============================================================================
error_handling:
  retry_policy:
    max_retries: 2
    initial_delay_ms: 100
    max_delay_ms: 1000
    exponential_base: 2
    retry_on:
      - "ConnectionError"
      - "TimeoutError"

  error_types:
    - name: "IntentClassificationError"
      description: "Failed to classify user prompt intent"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "KafkaPublishError"
      description: "Failed to publish to Kafka"
      recoverable: true
      retry_strategy: "exponential_backoff"

# =============================================================================
# CAPABILITIES
# =============================================================================
capabilities:
  - name: "unified_hook_handling"
    description: "Handle all Claude Code hook event types through single endpoint"
  - name: "intent_classification_routing"
    description: "Route UserPromptSubmit events to intent classification"
  - name: "kafka_emission"
    description: "Emit classified intents to Kafka for downstream consumers (graph storage handled by
      omnimemory consuming these events)"
  - name: "no_op_handlers"
    description: "Return success for event types not yet implemented"

# =============================================================================
# IDEMPOTENCY
# =============================================================================
idempotency:
  enabled: true
  strategy: "event_id_tracking"
  hash_fields: ["session_id", "event_type", "timestamp_utc"]
  description: "Each hook event is uniquely identified by the combination of session_id, event_type, and
    timestamp_utc. Re-processing the same hook event is idempotent - duplicate events with matching hash
    fields are detected and skipped to prevent double-processing of intent classification and Kafka emission."

# =============================================================================
# METADATA
# =============================================================================
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2026-01-23"
  updated: "2026-02-13"
  tags:
    - effect
    - claude-code
    - hooks
    - intent-classification
    - kafka
  references:
    - ticket: "OMN-1456"
      url: "https://linear.app/omninode/issue/OMN-1456"
      description: "Unified Claude Code hook endpoint"
    - ticket: "OMN-1626"
      url: "https://linear.app/omninode/issue/OMN-1626"
      description: "Add keywords field to intent-classified.v1 event payload"
    - ticket: "OMN-2210"
      url: "https://linear.app/omninode/issue/OMN-2210"
      description: "Wire intelligence nodes into registration + pattern extraction"
