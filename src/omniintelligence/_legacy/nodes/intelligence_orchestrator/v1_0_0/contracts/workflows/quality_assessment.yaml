name: quality_assessment_workflow
version:
  major: 1
  minor: 0
  patch: 0

description: |
  Llama Index workflow for code quality assessment.
  Evaluates quality across 6 dimensions and checks ONEX compliance.

workflow_type: sequential

steps:
  - name: validate_input
    type: validation
    description: Validate code input and language
    handler: validate_quality_input
    on_error: fail_immediately

  - name: emit_reducer_intent
    type: intent
    description: Emit intent to update FSM state to ASSESSING
    handler: emit_state_update_intent
    intent_type: STATE_UPDATE
    payload:
      fsm_type: QUALITY_ASSESSMENT
      new_state: ASSESSING

  - name: compute_quality_score
    type: compute
    description: Compute quality score across all dimensions
    compute_node: quality_scoring_compute
    input:
      file_path: ${input.file_path}
      content: ${input.content}
      language: ${input.language}
      project_name: ${input.project_name}
    output: quality_result

  - name: check_onex_compliance
    type: compute
    description: Check ONEX architectural compliance
    compute_node: quality_scoring_compute
    input:
      code: ${input.content}
      quality_score: ${quality_result.overall_score}
      language: ${input.language}
    output: compliance_result
    depends_on:
      - compute_quality_score

  - name: generate_recommendations
    type: compute
    description: Generate improvement recommendations
    compute_node: quality_scoring_compute
    input:
      quality_dimensions: ${quality_result.dimensions}
      compliance_issues: ${compliance_result.issues}
    output: recommendations
    depends_on:
      - check_onex_compliance

  - name: publish_assessment_event
    type: effect
    description: Publish quality assessment to Kafka
    effect_node: kafka_event_effect
    input:
      topic: quality.assessed.v1
      event_type: QUALITY_ASSESSMENT_COMPLETED
      payload:
        file_path: ${input.file_path}
        project_name: ${input.project_name}
        overall_score: ${quality_result.overall_score}
        dimensions: ${quality_result.dimensions}
        onex_compliant: ${compliance_result.compliant}
        recommendations_count: ${recommendations.list.length}
      correlation_id: ${input.correlation_id}

  - name: store_via_api
    type: effect
    description: Store quality assessment via intelligence API
    effect_node: intelligence_api_effect
    input:
      endpoint: /quality/store
      method: POST
      payload:
        file_path: ${input.file_path}
        quality_score: ${quality_result}
        compliance: ${compliance_result}
        recommendations: ${recommendations}
      correlation_id: ${input.correlation_id}

  - name: update_fsm_to_stored
    type: intent
    description: Update FSM state to STORED
    handler: emit_state_update_intent
    intent_type: STATE_UPDATE
    payload:
      fsm_type: QUALITY_ASSESSMENT
      entity_id: ${input.file_path}
      new_state: STORED
      metadata:
        overall_score: ${quality_result.overall_score}
        onex_compliant: ${compliance_result.compliant}

# Error handling
error_handling:
  on_step_failure:
    - name: publish_error_event
      type: effect
      effect_node: kafka_event_effect
      input:
        topic: quality.assessment.failed.v1
        event_type: QUALITY_ASSESSMENT_FAILED
        payload:
          file_path: ${input.file_path}
          failed_step: ${error.step}
          error_message: ${error.message}
        correlation_id: ${input.correlation_id}

    - name: update_fsm_to_failed
      type: intent
      handler: emit_state_update_intent
      intent_type: STATE_UPDATE
      payload:
        fsm_type: QUALITY_ASSESSMENT
        entity_id: ${input.file_path}
        new_state: FAILED
        metadata:
          error: ${error.message}
          failed_at_step: ${error.step}

  retry_policy:
    max_retries: 3
    retry_on_steps:
      - compute_quality_score
      - check_onex_compliance
      - store_via_api
    backoff_strategy: linear

# Performance settings
performance:
  timeout_seconds: 300
  enable_caching: true
  cache_key_template: "quality:${input.file_path}:${input.content.hash}"
  cache_ttl_seconds: 600

# Monitoring
monitoring:
  track_step_duration: true
  track_quality_trends: true
  emit_progress_events: false  # Too frequent for quality assessment
  log_level: INFO
