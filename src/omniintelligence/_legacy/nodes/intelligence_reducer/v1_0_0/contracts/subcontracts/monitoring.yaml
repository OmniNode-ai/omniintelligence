name: monitoring_subcontract
version:
  major: 1
  minor: 0
  patch: 0

description: |
  Monitoring operations subcontract for intelligence reducer.
  Handles health checks, metrics collection, and FSM observability.

operations:
  health_check:
    description: Check reducer health
    input:
      include_database: bool
    output:
      status: str
      uptime_seconds: int
      database_connected: bool
      active_leases: int
      last_error: str

  get_metrics:
    description: Get reducer metrics
    input:
      metric_types: list
      time_range_seconds: int
    output:
      transition_metrics:
        total_transitions: int
        successful_transitions: int
        failed_transitions: int
        average_duration_ms: float
      lease_metrics:
        active_leases: int
        expired_leases: int
        lease_conflicts: int
      fsm_metrics:
        entities_by_state: dict
        transitions_by_action: dict

  get_fsm_metrics:
    description: Get metrics for a specific FSM type
    input:
      fsm_type: EnumFSMType
      time_range_seconds: int
    output:
      total_entities: int
      state_distribution: dict
      transition_counts: dict
      average_time_in_state: dict
      error_rate: float

  get_transition_metrics:
    description: Get metrics for state transitions
    input:
      fsm_type: EnumFSMType
      from_state: str
      to_state: str
      time_range_seconds: int
    output:
      transition_count: int
      success_rate: float
      average_duration_ms: float
      p95_duration_ms: float

  get_lease_metrics:
    description: Get lease management metrics
    input:
      time_range_seconds: int
    output:
      total_leases: int
      active_leases: int
      expired_leases: int
      conflict_rate: float
      average_lease_duration_seconds: float

  get_database_metrics:
    description: Get database performance metrics
    input: {}
    output:
      connection_pool_size: int
      active_connections: int
      query_count: int
      average_query_time_ms: float
      slow_queries: list

  export_metrics:
    description: Export metrics in Prometheus format
    input:
      format: str
    output:
      metrics: str
      format: str
      timestamp: str

# Metrics collection settings
metrics:
  collection_interval_seconds: 60
  retention_period_hours: 168

  enabled_metrics:
    - transition_duration
    - transition_success_rate
    - state_distribution
    - lease_acquisition_time
    - lease_conflicts
    - database_query_time
    - intent_emission_count

  exporters:
    - type: prometheus
      endpoint: /metrics
      enabled: true

# Alerting thresholds
alerts:
  high_error_rate:
    threshold_percent: 10.0
    window_seconds: 300
    severity: critical

  slow_transitions:
    threshold_ms: 1000
    window_seconds: 300
    severity: warning

  lease_conflicts:
    threshold_count: 10
    window_seconds: 300
    severity: warning

  database_connection:
    threshold_count: 0
    severity: critical

  stuck_entities:
    threshold_hours: 24
    severity: warning

# Tracing configuration
tracing:
  enabled: true
  sample_rate: 1.0

  include_spans:
    - state_transition
    - lease_acquisition
    - database_query
    - intent_emission

# Logging configuration
logging:
  level: INFO
  structured_logging: true

  include_fields:
    - timestamp
    - fsm_type
    - entity_id
    - action
    - previous_state
    - current_state
    - correlation_id
    - duration_ms

  log_transitions: true
  log_lease_operations: true
  log_intent_emissions: true
  log_errors: true
