# FSM Subcontract: Pattern Learning
# Defines state machine for 4-phase pattern learning workflow
# FOUNDATION -> MATCHING -> VALIDATION -> TRACEABILITY -> COMPLETED

version:
  major: 1
  minor: 0
  patch: 0

state_machine_name: pattern_learning_fsm
state_machine_version:
  major: 1
  minor: 0
  patch: 0

description: |
  4-phase pattern learning finite state machine.
  Progresses through Foundation, Matching, Validation, and Traceability phases.
  Supports retry from FAILED state back to FOUNDATION.

# State Definitions
states:
  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: FOUNDATION
    state_type: operational
    description: Foundation phase - establishing base patterns
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - start_foundation
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: MATCHING
    state_type: operational
    description: Matching phase - pattern matching and correlation
    is_terminal: false
    is_recoverable: true
    timeout_ms: 600000  # 10 minutes
    entry_actions:
      - start_matching
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - foundation_results

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: VALIDATION
    state_type: operational
    description: Validation phase - validating matched patterns
    is_terminal: false
    is_recoverable: true
    timeout_ms: 300000  # 5 minutes
    entry_actions:
      - start_validation
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - matching_results

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: TRACEABILITY
    state_type: operational
    description: Traceability phase - establishing pattern lineage
    is_terminal: false
    is_recoverable: true
    timeout_ms: 300000  # 5 minutes
    entry_actions:
      - start_traceability
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - validation_results

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: COMPLETED
    state_type: snapshot
    description: Pattern learning completed successfully
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - notify_completion
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - traceability_results

  - version:
      major: 1
      minor: 0
      patch: 0
    state_name: FAILED
    state_type: error
    description: Pattern learning failed at some phase
    is_terminal: false
    is_recoverable: true
    entry_actions:
      - notify_failure
    exit_actions: []
    required_data:
      - entity_id
      - correlation_id
      - error_message
      - failed_phase

# Initial and Special States
initial_state: FOUNDATION
terminal_states: []  # Can always relearn
error_states:
  - FAILED

# Transition Definitions
transitions:
  # FOUNDATION transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: advance_to_matching
    from_state: FOUNDATION
    to_state: MATCHING
    trigger: ADVANCE_TO_MATCHING
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: PATTERN_LEARNING
          phase: MATCHING

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_foundation
    from_state: FOUNDATION
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: FOUNDATION

  # MATCHING transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: advance_to_validation
    from_state: MATCHING
    to_state: VALIDATION
    trigger: ADVANCE_TO_VALIDATION
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: PATTERN_LEARNING
          phase: VALIDATION

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_matching
    from_state: MATCHING
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: MATCHING

  # VALIDATION transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: advance_to_traceability
    from_state: VALIDATION
    to_state: TRACEABILITY
    trigger: ADVANCE_TO_TRACEABILITY
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: PATTERN_LEARNING
          phase: TRACEABILITY

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_validation
    from_state: VALIDATION
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: VALIDATION

  # TRACEABILITY transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: complete_learning
    from_state: TRACEABILITY
    to_state: COMPLETED
    trigger: COMPLETE_LEARNING
    priority: 1
    conditions: []
    actions:
      - action_name: emit_completion_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_COMPLETED

  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: fail_from_traceability
    from_state: TRACEABILITY
    to_state: FAILED
    trigger: FAIL
    priority: 1
    conditions: []
    actions:
      - action_name: emit_failure_event
        action_type: event
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          event_type: FSM_FAILED
          phase: TRACEABILITY

  # COMPLETED transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: relearn
    from_state: COMPLETED
    to_state: FOUNDATION
    trigger: RELEARN
    priority: 1
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: PATTERN_LEARNING
          phase: FOUNDATION

  # FAILED transitions
  - version:
      major: 1
      minor: 0
      patch: 0
    transition_name: retry_from_failed
    from_state: FAILED
    to_state: FOUNDATION
    trigger: RETRY
    priority: 1
    retry_enabled: true
    max_retries: 3
    retry_delay_ms: 10000
    conditions: []
    actions:
      - action_name: emit_workflow_intent
        action_type: intent
        version:
          major: 1
          minor: 0
          patch: 0
        parameters:
          intent_type: WORKFLOW_TRIGGER
          operation: PATTERN_LEARNING
          phase: FOUNDATION

# Persistence Configuration
persistence_enabled: true
checkpoint_interval_ms: 30000
max_checkpoints: 10
recovery_enabled: true
rollback_enabled: true

# Validation and Monitoring
strict_validation_enabled: true
state_monitoring_enabled: true
event_logging_enabled: true
conflict_resolution_strategy: priority_based
concurrent_transitions_allowed: false
transition_timeout_ms: 10000
