---
# Pre-commit hooks for omniintelligence
# Install: pre-commit install
# Run manually: pre-commit run --all-files
#
# ============================================================================
# PROFILING HOOK EXECUTION TIME
# ============================================================================
# To identify slow hooks and optimize performance, use --verbose (-v) mode:
#
#   pre-commit run --all-files --verbose
#
# This displays execution duration for each hook, e.g.:
#   yamlfmt..............................................................Passed
#   - hook id: yamlfmt
#   - duration: 0.01s
#
# Profile a single hook in isolation:
#
#   pre-commit run mypy --all-files --verbose
#   pre-commit run pytest-smoke --all-files --verbose
#
# For total execution time, wrap with the `time` command:
#
#   time pre-commit run --all-files --verbose
#
# ============================================================================
# EXPECTED TIMING BASELINES
# ============================================================================
# These are expected durations for a clean run. Use these to identify regressions:
#
#   Hook                      | Expected   | Warning Threshold | Action if Exceeded
#   --------------------------|------------|-------------------|--------------------
#   yamlfmt                   | <0.1s      | >0.5s             | Check file scope
#   trailing-whitespace       | <0.1s      | >0.3s             | Normal
#   end-of-file-fixer         | <0.1s      | >0.3s             | Normal
#   check-merge-conflict      | <0.1s      | >0.3s             | Normal
#   check-added-large-files   | <0.1s      | >0.5s             | Normal
#   ruff (lint)               | <0.1s      | >0.5s             | Check file scope
#   ruff (format)             | <0.1s      | >0.5s             | Check file scope
#   mypy (type check)         | ~0.2s      | >2.0s             | Check cache*
#   contract-linter           | <0.2s      | >1.0s             | Normal
#   pytest-smoke              | ~3-5s      | >10s              | Check test scope
#   pytest-tools (pre-push)   | ~5-10s     | >30s              | Check test scope
#
#   * mypy uses incremental cache - see "MYPY CACHE" section below
#
# ============================================================================
# TROUBLESHOOTING SLOW HOOKS
# ============================================================================
# If a hook consistently exceeds warning thresholds:
#
# 1. Narrow file scope:
#    - Check if `files` pattern is too broad
#    - Use `types: [python]` instead of regex when possible (faster)
#    - Add specific paths to the pattern rather than wildcards
#
# 2. Enable/verify caching:
#    - mypy: Uses --incremental flag (enabled) with .mypy_cache/
#    - pytest: Uses pytest cache in .pytest_cache/
#    - Delete cache directories to reset if corrupted:
#        rm -rf .mypy_cache .pytest_cache
#
# 3. Move to pre-push stage:
#    - Slow comprehensive tests belong in `stages: [pre-push]`
#    - Keep only fast smoke tests on pre-commit
#
# 4. Leverage fail_fast:
#    - fail_fast: true (enabled) stops on first failure
#    - Saves time during development by avoiding redundant hook runs
#
# 5. Check for environment issues:
#    - Ensure uv is using cached virtual environment
#    - Check disk I/O (slow on network drives)
#    - Verify no antivirus scanning interference
#
# ============================================================================
# MYPY INCREMENTAL CACHE
# ============================================================================
# mypy uses --incremental to leverage cached type information:
#
# How it works:
#   - First run: Full analysis, populates .mypy_cache/
#   - Subsequent runs: Only re-analyzes changed files (~10x faster)
#   - Cache location: .mypy_cache/ in repository root
#
# Local development:
#   - Cache persists between commits automatically
#   - Delete .mypy_cache/ to force full re-analysis if issues occur
#
# CI environment:
#   - .mypy_cache/ is cached in .github/workflows/ci.yaml (type-check job)
#   - Cache key based on Python version and dependency lock file
#   - Provides consistent incremental benefits across CI runs
#
# If mypy is slow (>2s):
#   1. Check if .mypy_cache/ exists and has recent files
#   2. Run `mypy --verbose` to see what's being re-analyzed
#   3. Delete cache and re-run to rule out cache corruption
#
# ============================================================================
#
# Hook Scope Summary:
# - yamlfmt: YAML formatting for consistency
# - pre-commit-hooks: File hygiene (trailing whitespace, EOF, merge conflicts)
# - ruff/mypy: All production Python code (tools/, utils/, runtime/) and their tests
# - contract-linter: ONEX node contracts (future nodes/ directory)
# - pytest-smoke: Quick unit tests on commit
# - pytest-tools: Full tools/utils/runtime tests on push only
#
# ============================================================================
# CI ALIGNMENT NOTICE - KEEP IN SYNC WITH .github/workflows/ci.yaml
# ============================================================================
# The file patterns in ruff/mypy hooks MUST stay aligned with CI path filters.
# When updating patterns here, also update the corresponding CI filters.
#
# Aligned patterns (pre-commit <-> CI):
# - ruff/mypy files: regex      <-> CI production_code filter: glob patterns
# - Source: tools/, utils/, runtime/ directories
# - Tests: tests/unit/tools/, tests/unit/test_log_sanitizer.py
#
# Validation: scripts/validate_ci_precommit_alignment.py checks alignment
# Run manually: uv run python scripts/validate_ci_precommit_alignment.py
# ============================================================================
#
# Global Exclusions (excluded from ALL hooks via exclude: block at bottom):
# - _legacy/: Legacy code preserved for migration reference
# - migration_sources/: Original omniarchon source code
# - .git/: Git internals
#
# Per-Hook Exclusions (excluded from specific hooks only):
# - .github/workflows/: Excluded from formatting hooks (yamlfmt, trailing-whitespace,
#   end-of-file-fixer) because GitHub Actions workflows have specific YAML syntax
#   requirements (expression syntax ${{ }}, multiline strings, run blocks) that
#   conflict with standard formatting rules. NOT excluded from check-merge-conflict
#   or check-added-large-files since those validations remain useful.
#
# ============================================================================
# SMART PERFORMANCE OPTIMIZATIONS
# ============================================================================
# These optimizations minimize pre-commit execution time:
#
# 1. fail_fast: true
#    - Stops processing on first hook failure
#    - Benefit: Saves 5-10s on average during active development
#    - Trade-off: May miss secondary failures (run without fail_fast periodically)
#
# 2. types: [python] instead of regex file matching
#    - Pre-commit's type system uses file magic/extension detection
#    - Faster than regex matching against all staged files
#    - Used on: ruff (lint/format), mypy, pytest hooks
#
# 3. Scoped file patterns
#    - Each hook only processes files it needs (not the entire repo)
#    - ruff/mypy: Only tools/, utils/, runtime/ directories
#    - pytest-smoke: Only tools/ directory (narrowest scope for fast feedback)
#    - Global exclusions: _legacy/, migration_sources/ avoid processing dead code
#
# 4. Hook ordering (implicit via config order)
#    - Fast hooks first: yamlfmt, trailing-whitespace, etc. (<0.1s each)
#    - Slow hooks last: mypy, pytest (0.2s-5s+)
#    - Benefit: Fail fast on simple issues before running expensive checks
#
# 5. Stage separation
#    - pre-commit: Fast checks only (lint, format, smoke tests)
#    - pre-push: Comprehensive tests (full pytest suite)
#    - Benefit: Keep commits fast, run thorough tests before push
#
# 6. Incremental caching
#    - mypy: --incremental flag uses .mypy_cache/ (~10x faster on re-runs)
#    - pytest: Uses .pytest_cache/ for test ordering and failure tracking
#    - uv: Caches virtual environment (avoids rebuild on each hook)
#
# 7. Parallel execution
#    - require_serial: false (default) allows hooks to run in parallel
#    - Note: Some hooks set require_serial: true when order matters

# Stop on first failure to avoid wasted hook runs during development
fail_fast: true

repos:
  # ============================================================================
  # YAML FORMATTING - Standard across ONEX ecosystem
  # ============================================================================
  - repo: https://github.com/google/yamlfmt
    # yamlfmt pinned to v0.17.2 for consistency with omnibase_core ecosystem
    # Configuration: .yamlfmt (repository root)
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        # GitHub Actions workflows are excluded because they have specific YAML syntax
        # requirements (e.g., expression syntax ${{ }}, multiline strings, run blocks)
        # that may conflict with standard yamlfmt formatting rules.
        # Note: migration_sources/ and _legacy/ are already covered by global exclusions
        exclude: ^\.github/workflows/

  # ============================================================================
  # FILE HYGIENE - Essential file formatting (standard across ecosystem)
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # GitHub Actions workflows excluded from formatting hooks - see header comment
      # for rationale (YAML syntax requirements conflict with standard formatters)
      # Note: migration_sources/ and _legacy/ are already covered by global exclusions
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^\.github/workflows/
      # These hooks intentionally have NO workflow exclusions (unlike formatting hooks above):
      # - check-merge-conflict: Merge markers are invalid everywhere, including workflows
      # - check-added-large-files: Size limits apply universally regardless of file type
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
  # ============================================================================
  # RUFF - Fast Python linter and formatter
  # Validates: Linting rules (flake8, isort, pyupgrade equivalents) and formatting
  # Scope: Production code (tools/, utils/, runtime/) and their unit tests
  # ============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.7
    hooks:
      - id: ruff
        name: ruff (lint)
        args: [--fix, --exit-non-zero-on-fix]
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Covers: tools/, utils/, runtime/ source code and their tests
        # test_log_sanitizer.py is included separately as it tests utils/log_sanitizer.py
        # functionality but lives in tests/unit/ rather than tests/unit/tools/
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

      - id: ruff-format
        name: ruff (format)
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Same scope as ruff lint (see comment above for test_log_sanitizer.py rationale)
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

  # ============================================================================
  # MYPY - Static type checking
  # Validates: Type annotations and type safety
  # Scope: Production source code only (tests may lack full type annotations)
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    # mypy pinned to v1.13.0 for stability (latest stable release as of Nov 2024)
    rev: v1.13.0
    hooks:
      - id: mypy
        name: mypy (type check)
        # --incremental uses mypy cache for faster subsequent runs
        # Locally: Cache in .mypy_cache/ speeds up repeated runs automatically
        # CI: .mypy_cache/ is cached in .github/workflows/ci.yaml (type-check job)
        #     to restore incremental benefits across workflow runs
        args: [--strict, --ignore-missing-imports, --incremental]
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Covers: tools/, utils/, runtime/ source code (not tests)
        files: ^src/omniintelligence/(tools|utils|runtime)/
        additional_dependencies:
          - types-PyYAML
          - pydantic>=2.0.0

  # ============================================================================
  # LOCAL HOOKS - Project-specific validators
  # ============================================================================
  - repo: local
    hooks:
      # --------------------------------------------------------------------------
      # Contract Linter - ONEX contract YAML validation
      # Validates: Node contracts against canonical Pydantic models
      # Scope: Main contracts (*_contract.yaml) and FSM files (fsm_*.yaml)
      #        in versioned node directories (e.g., nodes/foo/v1_0_0/contracts/)
      # Note: Excludes subcontracts/ and workflows/ subdirectories
      # Future-proof: Pattern ready for when nodes/ directory is created
      # --------------------------------------------------------------------------
      - id: contract-linter
        name: contract linter
        entry: uv run python -m omniintelligence.tools.contract_linter
        language: system
        pass_filenames: true
        # Pattern breakdown:
        # - ^src/omniintelligence/nodes/ : Base nodes directory
        # - [^/]+/                        : Node name (e.g., intelligence_reducer/)
        # - v\d+(_\d+)*/ or v[^/]+/       : Version dir (e.g., v1_0_0/, v2_0_0/)
        # - contracts/                    : Contracts subdirectory
        # - (.*_contract\.yaml|fsm_.*\.yaml) : Main contracts or FSM files
        files: ^src/omniintelligence/nodes/[^/]+/v\d+(_\d+)*/contracts/(.*_contract\.yaml|fsm_.*\.yaml)$

      # --------------------------------------------------------------------------
      # Pytest Smoke Tests - Quick unit tests on commit
      # Validates: Core functionality via fast unit tests
      # Scope: Triggered on changes to tools/ source or tests only (fast feedback)
      # Stage: pre-commit (fast, ~3s)
      # Performance: Narrow scope ensures smoke tests stay fast on every commit
      # Note: Full utils/runtime testing runs on pre-push (pytest-tools hook)
      # --------------------------------------------------------------------------
      - id: pytest-smoke
        name: pytest (smoke tests)
        entry: uv run pytest tests/unit/tools/ -m unit --maxfail=3 -x --tb=short -q
        language: system
        pass_filenames: false
        types: [python]
        # Trigger only on tools/ changes - narrow scope for fast smoke tests
        # utils/runtime changes are tested by pytest-tools on pre-push
        files: ^(src/omniintelligence/tools/|tests/unit/tools/).*\.py$
        stages: [pre-commit]

      # --------------------------------------------------------------------------
      # Pytest - Full tools/utils/runtime tests on push
      # Validates: Tools, utils, and runtime functionality via comprehensive unit tests
      # Scope: Matches ruff/mypy scope - tools/, utils/, runtime/ source and their tests
      # Stage: pre-push (slower, more thorough)
      # Note: test_log_sanitizer.py tests utils/log_sanitizer.py but lives in tests/unit/
      # --------------------------------------------------------------------------
      - id: pytest-tools
        name: pytest (tools/utils/runtime - full)
        entry: uv run pytest tests/unit/tools/ tests/unit/test_log_sanitizer.py -v --tb=short
        language: system
        pass_filenames: false
        types: [python]
        # Scope matches ruff/mypy: tools/, utils/, runtime/ and their tests
        # test_log_sanitizer.py is included separately (see comment above)
        # Pattern breakdown:
        #   - src/omniintelligence/(tools|utils|runtime)/.*\.py : Source directories
        #   - tests/unit/tools/.*\.py                           : Unit tests for tools
        #   - tests/unit/test_log_sanitizer\.py                 : Specific file (exact match)
        # Note: The specific file pattern must NOT have .*\.py$ suffix as it's already complete
        files: ^(src/omniintelligence/(tools|utils|runtime)/.*\.py|tests/unit/tools/.*\.py|tests/unit/test_log_sanitizer\.py)$
        stages: [pre-push]

# Default stage for hooks (commit, not push)
default_stages: [pre-commit]

# ============================================================================
# GLOBAL EXCLUSIONS
# These patterns are excluded from ALL hooks above
# ============================================================================
exclude: |
  (?x)^(
    # Legacy code preserved for migration reference - do not lint
    _legacy/.*|
    src/omniintelligence/_legacy/.*|
    # Original omniarchon source - reference only
    migration_sources/.*|
    # Git internals
    \.git/.*
  )$
