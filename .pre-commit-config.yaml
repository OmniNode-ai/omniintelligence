---
# Pre-commit hooks for omniintelligence
# Install: pre-commit install
# Run manually: pre-commit run --all-files
#
# Hook Scope Summary:
# - yamlfmt: YAML formatting for consistency
# - pre-commit-hooks: File hygiene (trailing whitespace, EOF, merge conflicts)
# - ruff/mypy: All production Python code (tools/, utils/, runtime/) and their tests
# - contract-linter: ONEX node contracts (future nodes/ directory)
# - pytest-smoke: Quick unit tests on commit
# - pytest-tools: Full tools/utils/runtime tests on push only
#
# Global Exclusions (excluded from ALL hooks via exclude: block at bottom):
# - _legacy/: Legacy code preserved for migration reference
# - migration_sources/: Original omniarchon source code
# - .git/: Git internals
#
# Per-Hook Exclusions (excluded from specific hooks only):
# - .github/workflows/: Excluded from formatting hooks (yamlfmt, trailing-whitespace,
#   end-of-file-fixer) because GitHub Actions workflows have specific YAML syntax
#   requirements (expression syntax ${{ }}, multiline strings, run blocks) that
#   conflict with standard formatting rules. NOT excluded from check-merge-conflict
#   or check-added-large-files since those validations remain useful.
#
# Performance Optimizations:
# - fail_fast: true - Stop on first failure to save time during development
# - types: [python] - Faster than regex patterns for type-based filtering
# - Hook ordering: Fast hooks (file hygiene) run before slow hooks (mypy, pytest)
# - require_serial: false (default) - Allow parallel execution where possible

# Stop on first failure to avoid wasted hook runs during development
fail_fast: true

repos:
  # ============================================================================
  # YAML FORMATTING - Standard across ONEX ecosystem
  # ============================================================================
  - repo: https://github.com/google/yamlfmt
    # yamlfmt pinned to v0.17.2 for consistency with omnibase_core ecosystem
    # Configuration: .yamlfmt (repository root)
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        # GitHub Actions workflows are excluded because they have specific YAML syntax
        # requirements (e.g., expression syntax ${{ }}, multiline strings, run blocks)
        # that may conflict with standard yamlfmt formatting rules.
        # Note: migration_sources/ and _legacy/ are already covered by global exclusions
        exclude: ^\.github/workflows/

  # ============================================================================
  # FILE HYGIENE - Essential file formatting (standard across ecosystem)
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # GitHub Actions workflows excluded from formatting hooks - see header comment
      # for rationale (YAML syntax requirements conflict with standard formatters)
      # Note: migration_sources/ and _legacy/ are already covered by global exclusions
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^\.github/workflows/
      # check-merge-conflict and check-added-large-files run on ALL files including workflows
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
  # ============================================================================
  # RUFF - Fast Python linter and formatter
  # Validates: Linting rules (flake8, isort, pyupgrade equivalents) and formatting
  # Scope: Production code (tools/, utils/, runtime/) and their unit tests
  # ============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.7
    hooks:
      - id: ruff
        name: ruff (lint)
        args: [--fix, --exit-non-zero-on-fix]
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Covers: tools/, utils/, runtime/ source code and their tests
        # test_log_sanitizer.py is included separately as it tests utils/log_sanitizer.py
        # functionality but lives in tests/unit/ rather than tests/unit/tools/
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

      - id: ruff-format
        name: ruff (format)
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Same scope as ruff lint (see comment above for test_log_sanitizer.py rationale)
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

  # ============================================================================
  # MYPY - Static type checking
  # Validates: Type annotations and type safety
  # Scope: Production source code only (tests may lack full type annotations)
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    # mypy pinned to v1.13.0 for stability (latest stable release as of Nov 2024)
    rev: v1.13.0
    hooks:
      - id: mypy
        name: mypy (type check)
        # --incremental uses mypy cache for faster subsequent runs (locally)
        # Note: In CI with fresh containers, --incremental provides no benefit but causes no harm.
        # For CI optimization, consider caching .mypy_cache/ directory.
        args: [--strict, --ignore-missing-imports, --incremental]
        # types: [python] is more efficient than files regex for Python detection
        types: [python]
        # Covers: tools/, utils/, runtime/ source code (not tests)
        files: ^src/omniintelligence/(tools|utils|runtime)/
        additional_dependencies:
          - types-PyYAML
          - pydantic>=2.0.0

  # ============================================================================
  # LOCAL HOOKS - Project-specific validators
  # ============================================================================
  - repo: local
    hooks:
      # --------------------------------------------------------------------------
      # Contract Linter - ONEX contract YAML validation
      # Validates: Node contracts against canonical Pydantic models
      # Scope: Main contracts (*_contract.yaml) and FSM files (fsm_*.yaml)
      #        in versioned node directories (e.g., nodes/foo/v1_0_0/contracts/)
      # Note: Excludes subcontracts/ and workflows/ subdirectories
      # Future-proof: Pattern ready for when nodes/ directory is created
      # --------------------------------------------------------------------------
      - id: contract-linter
        name: contract linter
        entry: uv run python -m omniintelligence.tools.contract_linter
        language: system
        pass_filenames: true
        # Pattern breakdown:
        # - ^src/omniintelligence/nodes/ : Base nodes directory
        # - [^/]+/                        : Node name (e.g., intelligence_reducer/)
        # - v\d+(_\d+)*/ or v[^/]+/       : Version dir (e.g., v1_0_0/, v2_0_0/)
        # - contracts/                    : Contracts subdirectory
        # - (.*_contract\.yaml|fsm_.*\.yaml) : Main contracts or FSM files
        files: ^src/omniintelligence/nodes/[^/]+/v\d+(_\d+)*/contracts/(.*_contract\.yaml|fsm_.*\.yaml)$

      # --------------------------------------------------------------------------
      # Pytest Smoke Tests - Quick unit tests on commit
      # Validates: Core functionality via fast unit tests
      # Scope: Triggered on changes to tools/ source or tests only (fast feedback)
      # Stage: pre-commit (fast, ~3s)
      # Performance: Narrow scope ensures smoke tests stay fast on every commit
      # Note: Full utils/runtime testing runs on pre-push (pytest-tools hook)
      # --------------------------------------------------------------------------
      - id: pytest-smoke
        name: pytest (smoke tests)
        entry: uv run pytest tests/unit/tools/ --maxfail=3 -x --tb=short -q
        language: system
        pass_filenames: false
        types: [python]
        # Trigger only on tools/ changes - narrow scope for fast smoke tests
        # utils/runtime changes are tested by pytest-tools on pre-push
        files: ^(src/omniintelligence/tools/|tests/unit/tools/).*\.py$
        stages: [pre-commit]

      # --------------------------------------------------------------------------
      # Pytest - Full tools/utils/runtime tests on push
      # Validates: Tools, utils, and runtime functionality via comprehensive unit tests
      # Scope: Matches ruff/mypy scope - tools/, utils/, runtime/ source and their tests
      # Stage: pre-push (slower, more thorough)
      # Note: test_log_sanitizer.py tests utils/log_sanitizer.py but lives in tests/unit/
      # --------------------------------------------------------------------------
      - id: pytest-tools
        name: pytest (tools/utils/runtime - full)
        entry: uv run pytest tests/unit/tools/ tests/unit/test_log_sanitizer.py -v --tb=short
        language: system
        pass_filenames: false
        types: [python]
        # Scope matches ruff/mypy: tools/, utils/, runtime/ and their tests
        # test_log_sanitizer.py is included separately (see comment above)
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py)).*\.py$
        stages: [pre-push]

# Default stage for hooks (commit, not push)
default_stages: [pre-commit]

# ============================================================================
# GLOBAL EXCLUSIONS
# These patterns are excluded from ALL hooks above
# ============================================================================
exclude: |
  (?x)^(
    # Legacy code preserved for migration reference - do not lint
    _legacy/.*|
    src/omniintelligence/_legacy/.*|
    # Original omniarchon source - reference only
    migration_sources/.*|
    # Git internals
    \.git/.*
  )$
