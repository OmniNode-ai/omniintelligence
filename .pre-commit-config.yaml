---
# Pre-commit hooks for omniintelligence
# Install: pre-commit install
# Run manually: pre-commit run --all-files
#
# Hook Scope Summary:
# - yamlfmt: YAML formatting for consistency
# - pre-commit-hooks: File hygiene (trailing whitespace, EOF, merge conflicts)
# - ruff/mypy: All production Python code (tools/, utils/, runtime/) and their tests
# - contract-linter: ONEX node contracts (future nodes/ directory)
# - pytest-smoke: Quick unit tests on commit
# - pytest-tools: Full tools tests on push only
#
# Excluded from all hooks:
# - _legacy/: Legacy code preserved for migration reference
# - migration_sources/: Original omniarchon source code

repos:
  # ============================================================================
  # YAML FORMATTING - Standard across ONEX ecosystem
  # ============================================================================
  - repo: https://github.com/google/yamlfmt
    # yamlfmt pinned to v0.17.2 for consistency with omnibase_core ecosystem
    # Configuration: .yamlfmt (repository root)
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        exclude: ^(migration_sources/|_legacy/|\.github/workflows/)

  # ============================================================================
  # FILE HYGIENE - Essential file formatting (standard across ecosystem)
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^\.github/workflows/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
  # ============================================================================
  # RUFF - Fast Python linter and formatter
  # Validates: Linting rules (flake8, isort, pyupgrade equivalents) and formatting
  # Scope: Production code (tools/, utils/, runtime/) and their unit tests
  # ============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.7
    hooks:
      - id: ruff
        name: ruff (lint)
        args: [--fix, --exit-non-zero-on-fix]
        # Covers: tools/, utils/, runtime/ source code and their tests
        # test_log_sanitizer.py is included separately as it tests utils/log_sanitizer.py
        # functionality but lives in tests/unit/ rather than tests/unit/tools/
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

      - id: ruff-format
        name: ruff (format)
        # Same scope as ruff lint (see comment above for test_log_sanitizer.py rationale)
        files: ^(src/omniintelligence/(tools|utils|runtime)/|tests/unit/(tools/|test_log_sanitizer\.py))

  # ============================================================================
  # MYPY - Static type checking
  # Validates: Type annotations and type safety
  # Scope: Production source code only (tests may lack full type annotations)
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        name: mypy (type check)
        args: [--strict, --ignore-missing-imports]
        # Covers: tools/, utils/, runtime/ source code (not tests)
        files: ^src/omniintelligence/(tools|utils|runtime)/
        additional_dependencies:
          - types-PyYAML
          - pydantic>=2.0.0

  # ============================================================================
  # LOCAL HOOKS - Project-specific validators
  # ============================================================================
  - repo: local
    hooks:
      # --------------------------------------------------------------------------
      # Contract Linter - ONEX contract YAML validation
      # Validates: Node contracts against canonical Pydantic models
      # Scope: Main contracts (*_contract.yaml) and FSM files (fsm_*.yaml)
      #        in versioned node directories (e.g., nodes/foo/v1_0_0/contracts/)
      # Note: Excludes subcontracts/ and workflows/ subdirectories
      # Future-proof: Pattern ready for when nodes/ directory is created
      # --------------------------------------------------------------------------
      - id: contract-linter
        name: contract linter
        entry: uv run python -m omniintelligence.tools.contract_linter
        language: system
        pass_filenames: true
        # Pattern breakdown:
        # - ^src/omniintelligence/nodes/ : Base nodes directory
        # - [^/]+/                        : Node name (e.g., intelligence_reducer/)
        # - v\d+(_\d+)*/ or v[^/]+/       : Version dir (e.g., v1_0_0/, v2_0_0/)
        # - contracts/                    : Contracts subdirectory
        # - (.*_contract\.yaml|fsm_.*\.yaml) : Main contracts or FSM files
        files: ^src/omniintelligence/nodes/[^/]+/v\d+(_\d+)*/contracts/(.*_contract\.yaml|fsm_.*\.yaml)$

      # --------------------------------------------------------------------------
      # Pytest Smoke Tests - Quick unit tests on commit
      # Validates: Core functionality via fast unit tests
      # Scope: Triggered on Python file changes in src or tests directories
      # Stage: pre-commit (fast, ~3s)
      # --------------------------------------------------------------------------
      - id: pytest-smoke
        name: pytest (smoke tests)
        entry: uv run pytest tests/unit/tools/ --maxfail=3 -x --tb=short -q
        language: system
        pass_filenames: false
        # Trigger on Python file changes in src or tests
        files: ^(src/omniintelligence/|tests/).*\.py$
        stages: [pre-commit]

      # --------------------------------------------------------------------------
      # Pytest - Full tools tests on push
      # Validates: Tools functionality via comprehensive unit tests
      # Scope: Triggered when tools source or test files change
      # Stage: pre-push (slower, more thorough)
      # --------------------------------------------------------------------------
      - id: pytest-tools
        name: pytest (tools - full)
        entry: uv run pytest tests/unit/tools/ -v --tb=short
        language: system
        pass_filenames: false
        # Trigger when either tools source or tests change
        files: ^(src/omniintelligence/tools/|tests/unit/tools/).*\.py$
        stages: [pre-push]

# Default stage for hooks (commit, not push)
default_stages: [pre-commit]

# ============================================================================
# GLOBAL EXCLUSIONS
# These patterns are excluded from ALL hooks above
# ============================================================================
exclude: |
  (?x)^(
    # Legacy code preserved for migration reference - do not lint
    _legacy/.*|
    src/omniintelligence/_legacy/.*|
    # Original omniarchon source - reference only
    migration_sources/.*|
    # Git internals
    \.git/.*
  )$
